<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trading Rules Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ---------- YOUR ORIGINAL THEME/COMPONENT STYLES (unchanged behavior) ---------- */
        .tab-button { transition: all 0.3s ease-in-out; }
        [data-theme='dark'] .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='light'] .tab-button.active {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='dark'] .tab-button { background-color: #374151; color: #d1d5db; }
        [data-theme='light'] .tab-button { background-color: #e5e7eb; color: #4b5563; }
        [data-theme='dark'] .bg-body { background-color: #0d1117; }
        [data-theme='light'] .bg-body { background-color: #f3f4f6; }
        [data-theme='dark'] .bg-container { background-color: #161b22; }
        [data-theme='light'] .bg-container { background-color: #ffffff; }
        [data-theme='dark'] .text-main { color: #f9fafb; }
        [data-theme='light'] .text-main { color: #1f2937; }
        [data-theme='dark'] .text-secondary { color: #d1d5db; }
        [data-theme='light'] .text-secondary { color: #4b5563; }
        /* Readability fix for inputs and results */
        [data-theme='dark'] .input-field input { background-color: #374151; color: white; border-color: #4b5563; }
        [data-theme='light'] .input-field input { background-color: #ffffff; color: #1f2937; border-color: #d1d5db; }
        [data-theme='dark'] .result-field > div { background-color: #4b5563; color: white; border-color: #6b7280; }
        [data-theme='light'] .result-field > div { background-color: #e5e7eb; color: #1f2937; border-color: #d1d5db; }
        .tab-content > div { border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }

        /* Theme-specific sheet colors (unchanged) */
        [data-theme='dark'] .bg-umbrella { background-color: #1e3a8a; } /* dark blue */
        [data-theme='light'] .bg-umbrella { background-color: #dbeafe; } /* light blue */
        [data-theme='dark'] .text-umbrella { color: #93c5fd; }
        [data-theme='light'] .text-umbrella { color: #1e3a8a; }

        [data-theme='dark'] .bg-bike { background-color: #065f46; } /* dark green */
        [data-theme='light'] .bg-bike { background-color: #dcfce7; } /* light green */
        [data-theme='dark'] .text-bike { color: #6ee7b7; }
        [data-theme='light'] .text-bike { color: #065f46; }

        [data-theme='dark'] .bg-rikshaw { background-color: #5b21b6; } /* dark purple */
        [data-theme='light'] .bg-rikshaw { background-color: #ede9fe; } /* light purple */
        [data-theme='dark'] .text-rikshaw { color: #c4b5fd; }
        [data-theme='light'] .text-rikshaw { color: #5b21b6; }

        [data-theme='dark'] .bg-car { background-color: #991b1b; } /* dark red */
        [data-theme='light'] .bg-car { background-color: #fee2e2; } /* light red */
        [data-theme='dark'] .text-car { color: #fca5a5; }
        [data-theme='light'] .text-car { color: #991b1b; }

        [data-theme='dark'] .bg-pandavas { background-color: #9a3412; } /* dark orange */
        [data-theme='light'] .bg-pandavas { background-color: #ffedd5; } /* light orange */
        [data-theme='dark'] .text-pandavas { color: #fdba74; }
        [data-theme='light'] .text-pandavas { color: #9a3412; }

        [data-theme='dark'] .bg-notes { background-color: #1e40af; } /* dark blue for notes */
        [data-theme='light'] .bg-notes { background-color: #c7d2fe; } /* light blue for notes */
        [data-theme='dark'] .text-notes { color: #93c5fd; }
        [data-theme='light'] .text-notes { color: #1e40af; }

        /* Modal styling (unchanged) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        [data-theme='dark'] .modal-content { background-color: #1f2937; color: #f9fafb; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        [data-theme='light'] .modal-content { background-color: #ffffff; color: #1f2937; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .history-item { cursor: pointer; transition: background-color 0.2s; }
        [data-theme='dark'] .history-item:hover { background-color: #2d3748; }
        [data-theme='light'] .history-item:hover { background-color: #e5e7eb; }

        .message-box {
            position: fixed; top: 1rem; right: 1rem; padding: 1rem 1.5rem; border-radius: 0.5rem;
            background-color: #38a169; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        .message-box.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .history-scroll-container { max-height: 500px; overflow-y: auto; }

        /* ---------- NEW: textured background + layout polish (non-functional) ---------- */

        /* subtle paper/noise texture using CSS gradients (works offline) */
        body[data-theme='dark'] {
            background-color: #0d1117; 
            color: #f9fafb;
            background-image:
                radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.0));
            background-size: 8px 8px, 100% 100%;
        }

        body[data-theme='light'] {
            background-color: #f3f4f6;
            color: #1f2937;
            background-image:
                radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
            background-size: 10px 10px, 100% 100%;
        }

        /* central container visual polish (keeps original sizes & styles) */
        .app-frame {
            width: 100%;
            max-width: 1100px;
            margin: 1.5rem auto;
            padding: 1.25rem;
        }
        .bg-container {
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(2,6,23,0.4);
            transition: box-shadow 0.25s ease;
        }
        [data-theme='light'] .bg-container {
            box-shadow: 0 8px 22px rgba(16,24,40,0.06);
        }

        /* Quote area at the bottom */
        #daily-quote {
            max-width: 1100px;
            margin: 1rem auto 3rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
            opacity: 0.95;
        }
        [data-theme='dark'] #daily-quote {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            color: #e6eefc;
            border: 1px solid rgba(255,255,255,0.03);
        }
        [data-theme='light'] #daily-quote {
            background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
            color: #0f172a;
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* theme toggle quick style */
        #theme-toggle { border-radius: 9999px; padding: 0.5rem; }
    </style>
</head>

<body class="bg-body min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans transition-colors duration-300" data-theme="dark">

    <div class="app-frame">
        <div class="w-full bg-container transition-colors duration-300 rounded-xl shadow-2xl p-6 sm:p-10">
            <!-- Theme Toggle and Help Button -->
            <div class="flex justify-end gap-2 mb-4">
                <button id="help-button" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-question text-xl"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-sun text-xl" id="toggle-icon"></i>
                </button>
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-main">Trading Rules Calculator</h1>
            <p class="text-center text-secondary mb-8 max-w-prose mx-auto text-sm sm:text-base">
                Enter your values and the calculator will automatically compute the results based on the chosen rule.
            </p>

            <!-- Tab Navigation -->
            <div id="tab-navigation" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600 active" data-sheet="Umbrella">Umbrella</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Bike">Bike</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Rikshaw">Rikshaw</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Car">Car</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Pandavas">Pandavas</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="History">History</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Notes">Notes</button>
            </div>

            <!-- Container for Sheet Content -->
            <div id="sheet-content"></div>

            <!-- Global Sharing Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-center text-xl font-bold text-main mb-4">Share this Calculator</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="share-whatsapp" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button id="share-telegram" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-telegram-plane"></i> Telegram
                    </button>
                    <button id="copy-link" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Link Section (from your original code) -->
    <div class="w-full max-w-4xl mt-4">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-xl flex justify-center items-center">
            <a href="https://t.me/Mathstrade" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-white font-semibold hover:text-indigo-400 transition-colors duration-200">
                <i class="fab fa-telegram-plane text-2xl"></i>
                <span class="text-lg">Connect on Telegram</span>
            </a>
        </div>
    </div>

    <!-- Daily Quote - new element (non functional change) -->
    <div id="daily-quote" aria-live="polite">Loading today's trader quoteâ€¦</div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content relative text-center">
            <button id="close-modal" class="absolute top-4 right-4 text-xl text-secondary hover:text-main">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4">How It Works</h2>
            <p class="text-lg text-secondary mb-4">
                This is a trading rules calculator. It helps you quickly determine key trading points based on specific formulas.
            </p>
            <ul class="text-left space-y-2 text-secondary text-sm sm:text-base">
                <li><strong class="text-main">Tabs:</strong> Each tab represents a different trading rule with its own unique calculation. The History tab shows all your saved data.</li>
                <li><strong class="text-main">Input Fields:</strong> Enter the required values (High, Low, etc.) for the selected rule.</li>
                <li><strong class="text-main">Results:</strong> The calculated results will appear automatically as you type or press 'Enter'.</li>
                <li><strong class="text-main">History:</strong> Save calculations for later and manage your saved data in the new History tab.</li>
                <li><strong class="text-main">CSV Options:</strong> In the History tab, you can export all your saved calculations as a single CSV file or copy them to your clipboard.</li>
            </ul>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Debounce function to limit how often a function is called
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // ---------- ORIGINAL MODULE: sheets and UI logic (kept intact) ----------
        const sheets = {
            Umbrella: {
                content: `
                    <div class="bg-umbrella p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-umbrella">Umbrella (Daily Candle)</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="input-field" data-label="Previous Day High" data-id="umbrella-high"></div>
                            <div class="input-field" data-label="Previous Day Low" data-id="umbrella-low"></div>
                            <div class="result-field" data-label="Range (High - Low)" data-id="umbrella-range"></div>
                            <div class="result-field" data-label="&quot;X&quot; (Range * 26.11%)" data-id="umbrella-x"></div>
                            <div class="result-field" data-label="High - &quot;X&quot;" data-id="umbrella-high-minus-x"></div>
                            <div class="result-field" data-label="Low + &quot;X&quot;" data-id="umbrella-low-plus-x"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `,
                calculate: () => {
                    const high = parseFloat(document.getElementById('umbrella-high').value);
                    const low = parseFloat(document.getElementById('umbrella-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const range = high - low;
                        const x = range * 0.2611;
                        const highMinusX = high - x;
                        const lowPlusX = low + x;

                        document.getElementById('umbrella-range').textContent = range.toFixed(2);
                        document.getElementById('umbrella-x').textContent = x.toFixed(2);
                        document.getElementById('umbrella-high-minus-x').textContent = highMinusX.toFixed(2);
                        document.getElementById('umbrella-low-plus-x').textContent = lowPlusX.toFixed(2);
                    } else {
                        document.getElementById('umbrella-range').textContent = '-';
                        document.getElementById('umbrella-x').textContent = '-';
                        document.getElementById('umbrella-high-minus-x').textContent = '-';
                        document.getElementById('umbrella-low-plus-x').textContent = '-';
                    }
                }
            },
            Bike: {
                content: `
                    <div class="bg-bike p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-bike">Bike (1/2 Day Candle, 195 Minutes)</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="input-field" data-label="High" data-id="bike-high"></div>
                            <div class="input-field" data-label="Low" data-id="bike-low"></div>
                            <div class="result-field" data-label="SQRT(High) &quot;X&quot;" data-id="bike-sqrt-high-x"></div>
                            <div class="result-field" data-label="Ding Ding (from &quot;X&quot;)" data-id="bike-ding-ding-x"></div>
                            <div class="result-field" data-label="High + Ding Ding" data-id="bike-high-plus-ding"></div>
                            <div class="result-field" data-label="SQRT(Low) &quot;Y&quot;" data-id="bike-sqrt-low-y"></div>
                            <div class="result-field" data-label="Ding Ding (from &quot;Y&quot;)" data-id="bike-ding-ding-y"></div>
                            <div class="result-field" data-label="Low - Ding Ding" data-id="bike-low-minus-ding"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `,
                calculate: () => {
                    const high = parseFloat(document.getElementById('bike-high').value);
                    const low = parseFloat(document.getElementById('bike-low').value);

                    if (!isNaN(high) && !isNaN(low) && high >= 0 && low >= 0) {
                        const sqrtHighX = Math.sqrt(high);
                        const dingDingX = sqrtHighX * 0.2611;
                        const highPlusDingDing = high + dingDingX;

                        const sqrtLowY = Math.sqrt(low);
                        const dingDingY = sqrtLowY * 0.2611;
                        const lowMinusDingDing = low - dingDingY;

                        document.getElementById('bike-sqrt-high-x').textContent = sqrtHighX.toFixed(2);
                        document.getElementById('bike-ding-ding-x').textContent = dingDingX.toFixed(2);
                        document.getElementById('bike-high-plus-ding').textContent = highPlusDingDing.toFixed(2);
                        document.getElementById('bike-sqrt-low-y').textContent = sqrtLowY.toFixed(2);
                        document.getElementById('bike-ding-ding-y').textContent = dingDingY.toFixed(2);
                        document.getElementById('bike-low-minus-ding').textContent = lowMinusDingDing.toFixed(2);
                    } else {
                        document.getElementById('bike-sqrt-high-x').textContent = '-';
                        document.getElementById('bike-ding-ding-x').textContent = '-';
                        document.getElementById('bike-high-plus-ding').textContent = '-';
                        document.getElementById('bike-sqrt-low-y').textContent = '-';
                        document.getElementById('bike-ding-ding-y').textContent = '-';
                        document.getElementById('bike-low-minus-ding').textContent = '-';
                    }
                }
            },
            Rikshaw: {
                content: `
                    <div class="bg-rikshaw p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-rikshaw">Rikshaw (5 Minutes Candle)</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="input-field" data-label="1st 5 Min Candles High" data-id="rikshaw-high"></div>
                            <div class="input-field" data-label="1st 5 Min Candles Low" data-id="rikshaw-low"></div>
                            <div class="result-field" data-label="High + 0.2611%" data-id="rikshaw-high-plus-26"></div>
                            <div class="result-field" data-label="High + 0.1306%" data-id="rikshaw-high-plus-13"></div>
                            <div class="result-field" data-label="Low - 0.2611%" data-id="rikshaw-low-minus-26"></div>
                            <div class="result-field" data-label="Low - 0.1306%" data-id="rikshaw-low-minus-13"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `,
                calculate: () => {
                    const high = parseFloat(document.getElementById('rikshaw-high').value);
                    const low = parseFloat(document.getElementById('rikshaw-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const highPlus26 = high * (1 + 0.002611);
                        const highPlus13 = high * (1 + 0.001306);
                        const lowMinus26 = low * (1 - 0.002611);
                        const lowMinus13 = low * (1 - 0.001306);

                        document.getElementById('rikshaw-high-plus-26').textContent = highPlus26.toFixed(2);
                        document.getElementById('rikshaw-high-plus-13').textContent = highPlus13.toFixed(2);
                        document.getElementById('rikshaw-low-minus-26').textContent = lowMinus26.toFixed(2);
                        document.getElementById('rikshaw-low-minus-13').textContent = lowMinus13.toFixed(2);
                    } else {
                        document.getElementById('rikshaw-high-plus-26').textContent = '-';
                        document.getElementById('rikshaw-high-plus-13').textContent = '-';
                        document.getElementById('rikshaw-low-minus-26').textContent = '-';
                        document.getElementById('rikshaw-low-minus-13').textContent = '-';
                    }
                }
            },
            Car: {
                content: `
                    <div class="bg-car p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-car">Car (5 Minutes Candle, 1 Hour Time Frame)</h2>
                        <p class="text-secondary mb-4">
                            This rule calculates the midpoint and a percentage range for your trading points.
                        </p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="input-field" data-label="1130-1230 High" data-id="car-high"></div>
                            <div class="input-field" data-label="1130-1230 Low" data-id="car-low"></div>
                            <div class="result-field" data-label="Midpoint (High + Low) / 2" data-id="car-midpoint"></div>
                            <div class="result-field" data-label="1.5% Above Midpoint" data-id="car-above"></div>
                            <div class="result-field" data-label="1.5% Below Midpoint" data-id="car-below"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `,
                calculate: () => {
                    const high = parseFloat(document.getElementById('car-high').value);
                    const low = parseFloat(document.getElementById('car-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const midpoint = (high + low) / 2;
                        const aboveMidpoint = midpoint * 1.015; // 1.5% above
                        const belowMidpoint = midpoint * 0.985; // 1.5% below

                        document.getElementById('car-midpoint').textContent = midpoint.toFixed(2);
                        document.getElementById('car-above').textContent = aboveMidpoint.toFixed(2);
                        document.getElementById('car-below').textContent = belowMidpoint.toFixed(2);
                    } else {
                        document.getElementById('car-midpoint').textContent = '-';
                        document.getElementById('car-above').textContent = '-';
                        document.getElementById('car-below').textContent = '-';
                    }
                }
            },
            Pandavas: {
                content: `
                    <div class="bg-pandavas p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-pandavas">Pandavas (1/2 Day Candle, 195 Minutes)</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold text-pandavas">1st Half Values</h3>
                                <div class="input-field" data-label="Yesterday's 1st Half High" data-id="pandavas-first-high"></div>
                                <div class="input-field" data-label="Yesterday's 1st Half Low" data-id="pandavas-first-low"></div>
                                <div class="input-field" data-label="Yesterday's 1st Half Close" data-id="pandavas-first-close"></div>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-lg font-bold text-pandavas">2nd Half Values</h3>
                                <div class="input-field" data-label="Yesterday's 2nd Half High" data-id="pandavas-second-high"></div>
                                <div class="input-field" data-label="Yesterday's 2nd Half Low" data-id="pandavas-second-low"></div>
                                <div class="input-field" data-label="Yesterday's 2nd Half Close" data-id="pandavas-second-close"></div>
                            </div>
                        </div>
                        <div class="mt-6 pt-6 border-t-2 border-pandavas grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="result-field" data-label="Average 1 (Pivot)" data-id="pandavas-avg1"></div>
                            <div class="result-field" data-label="Average 2 (Pivot)" data-id="pandavas-avg2"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `,
                calculate: () => {
                    const values1 = [
                        parseFloat(document.getElementById('pandavas-first-high').value),
                        parseFloat(document.getElementById('pandavas-first-low').value),
                        parseFloat(document.getElementById('pandavas-first-close').value)
                    ].filter(val => !isNaN(val));

                    if (values1.length === 3) {
                        const sum = values1.reduce((acc, current) => acc + current, 0);
                        document.getElementById('pandavas-avg1').textContent = (sum / 3).toFixed(2);
                    } else {
                        document.getElementById('pandavas-avg1').textContent = '-';
                    }

                    const values2 = [
                        parseFloat(document.getElementById('pandavas-second-high').value),
                        parseFloat(document.getElementById('pandavas-second-low').value),
                        parseFloat(document.getElementById('pandavas-second-close').value)
                    ].filter(val => !isNaN(val));

                    if (values2.length === 3) {
                        const sum = values2.reduce((acc, current) => acc + current, 0);
                        document.getElementById('pandavas-avg2').textContent = (sum / 3).toFixed(2);
                    } else {
                        document.getElementById('pandavas-avg2').textContent = '-';
                    }
                }
            },
            History: {
                content: `
                    <div class="bg-container p-6 sm:p-8 rounded-lg min-h-[400px]">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-main mb-4 sm:mb-0">Calculation History</h2>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button id="history-export-csv-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-file-csv"></i> Export as CSV
                                </button>
                                <button id="history-copy-csv-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-copy"></i> Copy as CSV
                                </button>
                                <button id="history-clear-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-trash"></i> Clear History
                                </button>
                            </div>
                        </div>
                        <div id="history-list" class="space-y-4 history-scroll-container">
                            <!-- History items will be dynamically added here -->
                            <p id="no-history-message" class="text-center text-secondary">No saved calculations yet.</p>
                        </div>
                    </div>
                `
            },
            Notes: {
                content: `
                    <div class="bg-notes p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-notes">My Sticky Notes</h2>
                        <div class="mb-4">
                            <textarea id="notes-textarea" class="w-full min-h-[200px] rounded-lg p-4 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-black dark:text-white" placeholder="Write your private trading notes here..."></textarea>
                        </div>
                        <div class="flex flex-wrap justify-end gap-2 sm:gap-4">
                            <button id="clear-notes-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-trash"></i> Clear Notes
                            </button>
                            <button id="save-notes-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Notes
                            </button>
                        </div>
                    </div>
                `
            }
        };

        // Helper function to create an input field
        const createInputField = (label, id, value = '') => `
            <div>
                <label class="block text-sm font-medium text-secondary mb-1">${label}</label>
                <input
                    type="number"
                    id="${id}"
                    value="${value}"
                    oninput="handleInputAndSave()"
                    onkeydown="handleKeyDown(event)"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 transition-colors duration-200"
                    placeholder="Enter value"
                />
            </div>
        `;

        // Helper function to create a result field
        const createResultField = (label, id, value = '-') => `
            <div>
                <label class="block text-sm font-medium text-secondary mb-1">${label}</label>
                <div id="${id}" class="mt-1 w-full rounded-md p-2 bg-gray-200 dark:bg-gray-700 text-main font-semibold">${value}</div>
            </div>
        `;

        // Function to show a message box
        const showMessageBox = (message, type = 'success') => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `message-box show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => {
                box.className = 'message-box';
            }, 3000);
        };
        
        // ---------- NEW: Logic for Notes and Sharing ----------

        const loadNotes = () => {
            const notesTextarea = document.getElementById('notes-textarea');
            const savedNotes = localStorage.getItem('trading-notes');
            if (notesTextarea) {
                notesTextarea.value = savedNotes || '';
            }
        };

        const saveNotes = () => {
            const notesTextarea = document.getElementById('notes-textarea');
            if (notesTextarea) {
                localStorage.setItem('trading-notes', notesTextarea.value);
                showMessageBox('Notes saved successfully!');
            }
        };
        
        const clearNotes = () => {
            const notesTextarea = document.getElementById('notes-textarea');
            if (notesTextarea) {
                notesTextarea.value = '';
                localStorage.removeItem('trading-notes');
                showMessageBox('Notes cleared!', 'success');
            }
        };

        const handleShare = (platform) => {
            const url = window.location.href;
            const message = "Check out this Trading Rules Calculator!";
            let shareUrl = '';

            switch (platform) {
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(message + ' ' + url)}`;
                    window.open(shareUrl, '_blank');
                    break;
                case 'telegram':
                    shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(message)}`;
                    window.open(shareUrl, '_blank');
                    break;
                case 'copy':
                    // Use a more reliable method for copying in iframes
                    const el = document.createElement('textarea');
                    el.value = url;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showMessageBox('Link copied to clipboard!', 'success');
                    break;
                default:
                    return;
            }
        };


        // Function to create HTML for a sheet
        const createSheetHTML = (sheetName) => {
            const sheet = sheets[sheetName];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sheet.content;

            const inputFields = tempDiv.querySelectorAll('[data-id][data-label]');
            inputFields.forEach(field => {
                field.innerHTML = createInputField(field.dataset.label, field.dataset.id, localStorage.getItem(field.dataset.id) || '');
            });

            const resultFields = tempDiv.querySelectorAll('.result-field');
            resultFields.forEach(field => {
                field.innerHTML = createResultField(field.dataset.label, field.dataset.id);
            });

            return tempDiv.innerHTML;
        };

        // Function to switch between tabs
        const switchTab = (sheetName) => {
            const sheetContent = document.getElementById('sheet-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(button => {
                if (button.dataset.sheet === sheetName) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Dynamically create and inject content
            sheetContent.innerHTML = createSheetHTML(sheetName);

            // Special logic for History and Notes tabs
            if (sheetName === 'History') {
                updateHistoryList();
            } else if (sheetName === 'Notes') {
                loadNotes();
                document.getElementById('save-notes-button').onclick = saveNotes;
                document.getElementById('clear-notes-button').onclick = clearNotes;
                document.getElementById('notes-textarea').oninput = saveNotes; // Autosave on input
            } else {
                // Attach event listeners and calculate for other sheets
                const currentSheet = sheets[sheetName];
                const inputElements = document.querySelectorAll(`#sheet-content input[type='number']`);
                inputElements.forEach(input => {
                    input.addEventListener('input', () => {
                        currentSheet.calculate();
                        localStorage.setItem(input.id, input.value);
                    });
                });
                
                // Attach save button listener
                const saveButton = document.getElementById('save-button');
                if (saveButton) {
                    saveButton.onclick = () => saveCalculation(sheetName);
                }

                currentSheet.calculate(); // Initial calculation on tab switch
            }
        };

        const handleInputAndSave = () => {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const sheetName = activeTab.dataset.sheet;
                const currentSheet = sheets[sheetName];
                if (currentSheet && currentSheet.calculate) {
                    currentSheet.calculate();
                }
            }
        };
        
        const handleKeyDown = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const activeTab = document.querySelector('.tab-button.active');
                if (activeTab) {
                    const sheetName = activeTab.dataset.sheet;
                    if (sheets[sheetName] && sheets[sheetName].calculate) {
                        sheets[sheetName].calculate();
                    }
                }
            }
        };

        // Function to save a calculation to history
        const saveCalculation = (sheetName) => {
            const history = JSON.parse(localStorage.getItem('trading-history')) || [];
            const timestamp = new Date().toLocaleString();
            const inputs = {};
            const outputs = {};
            
            const inputElements = document.querySelectorAll(`#sheet-content .input-field input`);
            const outputElements = document.querySelectorAll(`#sheet-content .result-field div`);
            
            inputElements.forEach(input => {
                inputs[input.previousElementSibling.textContent] = input.value;
            });
            
            outputElements.forEach(output => {
                outputs[output.previousElementSibling.textContent] = output.textContent;
            });
            
            const newEntry = {
                id: Date.now(),
                timestamp,
                sheetName,
                inputs,
                outputs
            };
            
            history.unshift(newEntry);
            localStorage.setItem('trading-history', JSON.stringify(history));
            showMessageBox(`Calculation saved to history!`);
        };

        // Function to clear all history
        const clearHistory = () => {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                localStorage.removeItem('trading-history');
                updateHistoryList();
                showMessageBox('History cleared successfully!');
            }
        };

        // Function to load history from local storage and render it
        const updateHistoryList = () => {
            const historyList = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('trading-history')) || [];
            
            if (history.length === 0) {
                if(historyList) historyList.innerHTML = `<p class="text-center text-secondary">No saved calculations yet.</p>`;
                return;
            }
            
            historyList.innerHTML = history.map(entry => {
                const inputHtml = Object.entries(entry.inputs).map(([key, value]) => `
                    <p class="text-sm text-secondary truncate"><strong class="text-main">${key}:</strong> ${value}</p>
                `).join('');

                const outputHtml = Object.entries(entry.outputs).map(([key, value]) => `
                    <p class="text-sm text-secondary truncate"><strong class="text-main">${key}:</strong> ${value}</p>
                `).join('');
                
                return `
                    <div class="history-item bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm border-l-4 border-blue-500 flex justify-between items-center" data-id="${entry.id}">
                        <div>
                            <div class="font-bold text-lg text-main">${entry.sheetName} Calculation <span class="text-xs font-normal text-secondary">${entry.timestamp}</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                                <div><h4 class="font-semibold text-main mb-1">Inputs:</h4>${inputHtml}</div>
                                <div><h4 class="font-semibold text-main mb-1">Outputs:</h4>${outputHtml}</div>
                            </div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 ml-4 delete-history-item" data-id="${entry.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Add click listeners to delete buttons
            document.querySelectorAll('.delete-history-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteHistoryItem(parseInt(e.currentTarget.dataset.id));
                });
            });
            
            // Add click listeners to history items to restore values
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    restoreCalculation(id);
                });
            });
            
            // Attach event listeners for export/copy buttons
            document.getElementById('history-export-csv-button').onclick = exportHistoryToCSV;
            document.getElementById('history-copy-csv-button').onclick = copyHistoryToCSV;
            document.getElementById('history-clear-button').onclick = clearHistory;
        };

        // Function to delete a single history item
        const deleteHistoryItem = (id) => {
            let history = JSON.parse(localStorage.getItem('trading-history')) || [];
            history = history.filter(item => item.id !== id);
            localStorage.setItem('trading-history', JSON.stringify(history));
            updateHistoryList();
            showMessageBox('Item deleted from history.', 'success');
        };

        // Function to restore a calculation from history
        const restoreCalculation = (id) => {
            const history = JSON.parse(localStorage.getItem('trading-history')) || [];
            const entry = history.find(item => item.id === id);
            if (!entry) return;

            // Switch to the correct tab
            const tabButton = document.querySelector(`[data-sheet="${entry.sheetName}"]`);
            if (tabButton) {
                switchTab(entry.sheetName);
            }
            
            // Restore input values
            for (const [label, value] of Object.entries(entry.inputs)) {
                const inputElement = document.querySelector(`#sheet-content .input-field[data-label="${label}"] input`);
                if (inputElement) {
                    inputElement.value = value;
                }
            }
            
            // Trigger calculation
            if (sheets[entry.sheetName].calculate) {
                sheets[entry.sheetName].calculate();
            }
            showMessageBox('Calculation restored!', 'success');
        };

        // Function to export history as a CSV file
        const exportHistoryToCSV = () => {
            const history = JSON.parse(localStorage.getItem('trading-history')) || [];
            if (history.length === 0) {
                showMessageBox('No history to export.', 'error');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Collect all unique headers
            const headers = new Set(['Timestamp', 'Rule']);
            history.forEach(entry => {
                Object.keys(entry.inputs).forEach(key => headers.add(key));
                Object.keys(entry.outputs).forEach(key => headers.add(key));
            });
            const headerArray = [...headers];
            csvContent += headerArray.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + "\n";
            
            history.forEach(entry => {
                const row = headerArray.map(header => {
                    let value = '';
                    if (header === 'Timestamp') {
                        value = entry.timestamp;
                    } else if (header === 'Rule') {
                        value = entry.sheetName;
                    } else if (entry.inputs[header]) {
                        value = entry.inputs[header];
                    } else if (entry.outputs[header]) {
                        value = entry.outputs[header];
                    }
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvContent += row.join(',') + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "trading_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox('History exported as CSV!', 'success');
        };

        // Function to copy history to clipboard as CSV
        const copyHistoryToCSV = () => {
            const history = JSON.parse(localStorage.getItem('trading-history')) || [];
            if (history.length === 0) {
                showMessageBox('No history to copy.', 'error');
                return;
            }

            let csvText = "";
            const headers = new Set(['Timestamp', 'Rule']);
            history.forEach(entry => {
                Object.keys(entry.inputs).forEach(key => headers.add(key));
                Object.keys(entry.outputs).forEach(key => headers.add(key));
            });
            const headerArray = [...headers];
            csvText += headerArray.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + "\n";

            history.forEach(entry => {
                const row = headerArray.map(header => {
                    let value = '';
                    if (header === 'Timestamp') {
                        value = entry.timestamp;
                    } else if (header === 'Rule') {
                        value = entry.sheetName;
                    } else if (entry.inputs[header]) {
                        value = entry.inputs[header];
                    } else if (entry.outputs[header]) {
                        value = entry.outputs[header];
                    }
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvText += row.join(',') + "\n";
            });

            // Fallback for document.execCommand('copy') in iframes
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = csvText;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);

            showMessageBox('History copied to clipboard as CSV!', 'success');
        };

        // Quote fetching function
        const fetchDailyQuote = async () => {
            const quotes = [
                "The trend is your friend until it bends.",
                "Cut your losses short and let your profits run.",
                "Donâ€™t trade what you think, trade what you see.",
                "Risk comes from not knowing what you're doing.",
                "The biggest risk is not taking any risk.",
                "Don't put all your eggs in one basket.",
                "Patience is a key element of success."
            ];
            const quoteElement = document.getElementById('daily-quote');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            quoteElement.innerHTML = `"${randomQuote}"`;
        };

        // Theme toggle logic
        const toggleTheme = () => {
            const body = document.body;
            const toggleIcon = document.getElementById('toggle-icon');
            if (body.dataset.theme === 'dark') {
                body.dataset.theme = 'light';
                toggleIcon.className = 'fas fa-moon text-xl';
            } else {
                body.dataset.theme = 'dark';
                toggleIcon.className = 'fas fa-sun text-xl';
            }
        };

        // Initial setup and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial theme from local storage or set default
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.dataset.theme = savedTheme;
            if (savedTheme === 'light') {
                document.getElementById('toggle-icon').className = 'fas fa-moon text-xl';
            } else {
                document.getElementById('toggle-icon').className = 'fas fa-sun text-xl';
            }

            // Set up event listeners for theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('help-button').addEventListener('click', () => {
                const modal = document.getElementById('help-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('active'), 10);
            });
            document.getElementById('close-modal').addEventListener('click', () => {
                const modal = document.getElementById('help-modal');
                modal.classList.remove('active');
                setTimeout(() => modal.classList.add('hidden'), 300);
            });
            
            // Tab navigation
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.sheet);
                });
            });

            // New Share button listeners
            document.getElementById('share-whatsapp').onclick = () => handleShare('whatsapp');
            document.getElementById('share-telegram').onclick = () => handleShare('telegram');
            document.getElementById('copy-link').onclick = () => handleShare('copy');

            // Initial view
            switchTab('Umbrella');
            fetchDailyQuote();
        });
    </script>
</body>
</html>
