<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Rules Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ---------- YOUR ORIGINAL THEME/COMPONENT STYLES (unchanged behavior) ---------- */
        .tab-button { transition: all 0.3s ease-in-out; }
        [data-theme='dark'] .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='light'] .tab-button.active {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='dark'] .tab-button { background-color: #374151; color: #d1d5db; }
        [data-theme='light'] .tab-button { background-color: #e5e7eb; color: #4b5563; }
        [data-theme='dark'] .bg-body { background-color: #0d1117; }
        [data-theme='light'] .bg-body { background-color: #f3f4f6; }
        [data-theme='dark'] .bg-container { background-color: #161b22; }
        [data-theme='light'] .bg-container { background-color: #ffffff; }
        [data-theme='dark'] .text-main { color: #f9fafb; }
        [data-theme='light'] .text-main { color: #1f2937; }
        [data-theme='dark'] .text-secondary { color: #d1d5db; }
        [data-theme='light'] .text-secondary { color: #4b5563; }
        /* Readability fix for inputs and results */
        [data-theme='dark'] .input-field input { background-color: #374151; color: white; border-color: #4b5563; }
        [data-theme='light'] .input-field input { background-color: #ffffff; color: #1f2937; border-color: #d1d5db; }
        /* ----- UPDATED OUTPUT BOX STYLES FOR iOS-INSPIRED LOOK ----- */
        [data-theme='dark'] .result-field > div { 
            background-color: #374151; /* Deeper gray for dark theme */
            color: #f9fafb; 
            border: 1px solid #4b5563; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); /* Subtle dark shadow */
            transition: all 0.2s ease;
        }
        [data-theme='light'] .result-field > div { 
            background-color: #f9fafb; /* Lighter background for light theme */
            color: #1f2937; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); /* Subtle light shadow */
            transition: all 0.2s ease;
        }
        /* Common styles for result fields */
        .result-field > div { 
            border-radius: 0.75rem; /* More rounded corners */
        }
        /* ----------------------------------------------------------- */
        
        .tab-content > div { border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }

        /* Theme-specific sheet colors (unchanged) */
        [data-theme='dark'] .bg-umbrella { background-color: #1e3a8a; } /* dark blue */
        [data-theme='light'] .bg-umbrella { background-color: #dbeafe; } /* light blue */
        [data-theme='dark'] .text-umbrella { color: #93c5fd; }
        [data-theme='light'] .text-umbrella { color: #1e3a8a; }

        [data-theme='dark'] .bg-bike { background-color: #065f46; } /* dark green */
        [data-theme='light'] .bg-bike { background-color: #dcfce7; } /* light green */
        [data-theme='dark'] .text-bike { color: #6ee7b7; }
        [data-theme='light'] .text-bike { color: #065f46; }

        [data-theme='dark'] .bg-rikshaw { background-color: #5b21b6; } /* dark purple */
        [data-theme='light'] .bg-rikshaw { background-color: #ede9fe; } /* light purple */
        [data-theme='dark'] .text-rikshaw { color: #c4b5fd; }
        [data-theme='light'] .text-rikshaw { color: #5b21b6; }

        [data-theme='dark'] .bg-car { background-color: #991b1b; } /* dark red */
        [data-theme='light'] .bg-car { background-color: #fee2e2; } /* light red */
        [data-theme='dark'] .text-car { color: #fca5a5; }
        [data-theme='light'] .text-car { color: #991b1b; }

        [data-theme='dark'] .bg-pandavas { background-color: #9a3412; } /* dark orange */
        [data-theme='light'] .bg-pandavas { background-color: #ffedd5; } /* light orange */
        [data-theme='dark'] .text-pandavas { color: #fdba74; }
        [data-theme='light'] .text-pandavas { color: #9a3412; }

        [data-theme='dark'] .bg-notes { background-color: #1e40af; } /* dark blue for notes */
        [data-theme='light'] .bg-notes { background-color: #c7d2fe; } /* light blue for notes */
        [data-theme='dark'] .text-notes { color: #93c5fd; }
        [data-theme='light'] .text-notes { color: #1e40af; }

        /* Modal styling (unchanged) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        [data-theme='dark'] .modal-content { background-color: #1f2937; color: #f9fafb; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        [data-theme='light'] .modal-content { background-color: #ffffff; color: #1f2937; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .history-item { cursor: pointer; transition: background-color 0.2s; }
        [data-theme='dark'] .history-item:hover { background-color: #2d3748; }
        [data-theme='light'] .history-item:hover { background-color: #e5e7eb; }

        .message-box {
            position: fixed; top: 1rem; right: 1rem; padding: 1rem 1.5rem; border-radius: 0.5rem;
            background-color: #38a169; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        .message-box.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .history-scroll-container { max-height: 500px; overflow-y: auto; }
        .history-table-container { max-height: 450px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ---------- NEW: textured background + layout polish (non-functional) ---------- */

        /* subtle paper/noise texture using CSS gradients (works offline) */
        body[data-theme='dark'] {
            background-color: #0d1117;
            color: #f9fafb;
            background-image:
                radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.0));
            background-size: 8px 8px, 100% 100%;
        }

        body[data-theme='light'] {
            background-color: #f3f4f6;
            color: #1f2937;
            background-image:
                radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
            background-size: 10px 10px, 100% 100%;
        }

        /* central container visual polish (keeps original sizes & styles) */
        .app-frame {
            width: 100%;
            max-width: 1100px;
            margin: 1.5rem auto;
            padding: 1.25rem;
        }
        .bg-container {
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(2,6,23,0.4);
            transition: box-shadow 0.25s ease;
        }
        [data-theme='light'] .bg-container {
            box-shadow: 0 8px 22px rgba(16,24,40,0.06);
        }

        /* Quote area at the bottom */
        #daily-quote {
            max-width: 1100px;
            margin: 1rem auto 3rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
            opacity: 0.95;
        }
        [data-theme='dark'] #daily-quote {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            color: #e6eefc;
            border: 1px solid rgba(255,255,255,0.03);
        }
        [data-theme='light'] #daily-quote {
            background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
            color: #0f172a;
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* theme toggle quick style */
        #theme-toggle { border-radius: 9999px; padding: 0.5rem; }
    </style>
</head>

<body class="bg-body min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans transition-colors duration-300" data-theme="dark">

    <div class="app-frame">
        <div class="w-full bg-container transition-colors duration-300 rounded-xl shadow-2xl p-6 sm:p-10">
            <!-- Theme Toggle and Help Button -->
            <div class="flex justify-end gap-2 mb-4">
                <button id="help-button" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-question text-xl"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-sun text-xl" id="toggle-icon"></i>
                </button>
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-main">Trading Rules Calculator</h1>
            <p class="text-center text-secondary mb-8 max-w-prose mx-auto text-sm sm:text-base">
                Enter your values and the calculator will automatically compute the results based on the chosen rule.
            </p>

            <!-- Tab Navigation -->
            <div id="tab-navigation" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600 active" data-sheet="Umbrella">Umbrella</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Bike">Bike</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Rikshaw">Rikshaw</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Car">Car</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Pandavas">Pandavas</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="History">History</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Notes">Notes</button>
            </div>

            <!-- Container for Sheet Content -->
            <div id="sheet-content"></div>

            <!-- Global Sharing Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-center text-xl font-bold text-main mb-4">Share this Calculator</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="share-whatsapp" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button id="share-telegram" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-telegram-plane"></i> Telegram
                    </button>
                    <button id="copy-link" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Link Section (from your original code) -->
    <div class="w-full max-w-4xl mt-4">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-xl flex justify-center items-center">
            <a href="https://t.me/Mathstrade" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-white font-semibold hover:text-indigo-400 transition-colors duration-200">
                <i class="fab fa-telegram-plane text-2xl"></i>
                <span class="text-lg">Connect on Telegram</span>
            </a>
        </div>
    </div>

    <!-- Daily Quote - new element (non functional change) -->
    <div id="daily-quote" aria-live="polite" class="bg-container">
      <div class="flex items-center justify-center space-x-2">
        <div class="loading-spinner"></div>
        <span>Loading today's trader quoteâ€¦</span>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content relative text-center">
            <button id="close-modal" class="absolute top-4 right-4 text-xl text-secondary hover:text-main">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4">How It Works</h2>
            <p class="text-lg text-secondary mb-4">
                This is a trading rules calculator. It helps you quickly determine key trading points based on specific formulas.
            </p>
            <ul class="text-left space-y-2 text-secondary text-sm sm:text-base">
                <li><strong class="text-main">Tabs:</strong> Each tab represents a different trading rule with its own unique calculation. The History tab shows all your saved data.</li>
                <li><strong class="text-main">Input Fields:</strong> Enter the required values (High, Low, etc.) for the selected rule.</li>
                <li><strong class="text-main">Results:</strong> The calculated results will appear automatically as you type or press 'Enter'.</li>
                <li><strong class="text-main">History:</strong> Save calculations for later and manage your saved data in the new History tab.</li>
                <li><strong class="text-main">CSV Options:</strong> In the History tab, you can export all your saved calculations as a single CSV file or copy them to your clipboard.</li>
            </ul>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Global App State
        window.app = {
            state: {
                theme: 'dark',
                activeSheet: 'Umbrella',
                calculations: [],
                notes: "",
                userId: null,
            },
        };

        // Debounce function to limit how often a function is called
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Utility function to show a temporary message box
        const showMessage = (message, type = 'success') => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `message-box show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        };

        // Utility function to copy text to clipboard
        const copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessage('Copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy.', 'error');
            }
            document.body.removeChild(textarea);
        };

        // Dynamic HTML for input and result fields
        const renderInputField = (label, id, value = '') => `
            <div class="input-field mb-4">
                <label for="${id}" class="block text-sm font-medium text-secondary">${label}</label>
                <input type="number" id="${id}" step="0.01" class="mt-1 block w-full rounded-md shadow-sm border border-gray-300 py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter value" value="${value}" />
            </div>
        `;
        const renderResultField = (label, id, value = '-') => `
            <div class="result-field p-3">
                <div class="text-xs font-semibold uppercase text-secondary">${label}</div>
                <div id="${id}" class="text-xl font-bold mt-1 text-main">${value}</div>
            </div>
        `;

        // Local Storage Functions
        const saveToLocalStorage = () => {
            localStorage.setItem('calculations', JSON.stringify(window.app.state.calculations));
            localStorage.setItem('notes', window.app.state.notes);
            // We don't need a success message every time the user types.
        };

        const loadFromLocalStorage = () => {
            try {
                const savedCalculations = localStorage.getItem('calculations');
                const savedNotes = localStorage.getItem('notes');
                if (savedCalculations) {
                    window.app.state.calculations = JSON.parse(savedCalculations);
                }
                if (savedNotes) {
                    window.app.state.notes = savedNotes;
                }
            } catch (e) {
                console.error("Failed to load from local storage:", e);
                // Clear corrupted data
                localStorage.removeItem('calculations');
                localStorage.removeItem('notes');
                window.app.state.calculations = [];
                window.app.state.notes = "";
            }
        };

        // Sheet Definitions with new render functions
        const sheets = {
            Umbrella: {
                title: "Umbrella (Daily Candle)",
                class: "umbrella",
                fields: [
                    { type: 'input', label: 'Previous Day High', id: 'umbrella-high' },
                    { type: 'input', label: 'Previous Day Low', id: 'umbrella-low' },
                    { type: 'result', label: 'Range (High - Low)', id: 'umbrella-range' },
                    { type: 'result', label: '"X" (Range * 26.11%)', id: 'umbrella-x' },
                    { type: 'result', label: 'High - "X"', id: 'umbrella-high-minus-x' },
                    { type: 'result', label: 'Low + "X"', id: 'umbrella-low-plus-x' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('umbrella-high').value);
                    const low = parseFloat(document.getElementById('umbrella-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const range = high - low;
                        const x = range * 0.2611;
                        const highMinusX = high - x;
                        const lowPlusX = low + x;

                        document.getElementById('umbrella-range').textContent = range.toFixed(2);
                        document.getElementById('umbrella-x').textContent = x.toFixed(2);
                        document.getElementById('umbrella-high-minus-x').textContent = highMinusX.toFixed(2);
                        document.getElementById('umbrella-low-plus-x').textContent = lowPlusX.toFixed(2);
                        return { 
                            name: sheets.Umbrella.title,
                            date: new Date().toISOString(),
                            inputs: { 'Previous Day High': high, 'Previous Day Low': low }, 
                            results: { 'Range': range, '"X"': x, 'High - "X"': highMinusX, 'Low + "X"': lowPlusX } 
                        };
                    } else {
                        document.getElementById('umbrella-range').textContent = '-';
                        document.getElementById('umbrella-x').textContent = '-';
                        document.getElementById('umbrella-high-minus-x').textContent = '-';
                        document.getElementById('umbrella-low-plus-x').textContent = '-';
                        return null;
                    }
                }
            },
            Bike: {
                title: "Bike (1/2 Day Candle, 195 Minutes)",
                class: "bike",
                fields: [
                    { type: 'input', label: 'High', id: 'bike-high' },
                    { type: 'input', label: 'Low', id: 'bike-low' },
                    { type: 'result', label: 'SQRT(High) "X"', id: 'bike-sqrt-high-x' },
                    { type: 'result', label: 'Ding Ding (from "X")', id: 'bike-ding-ding-x' },
                    { type: 'result', label: 'High + Ding Ding', id: 'bike-high-plus-ding' },
                    { type: 'result', label: 'SQRT(Low) "Y"', id: 'bike-sqrt-low-y' },
                    { type: 'result', label: 'Ding Ding (from "Y")', id: 'bike-ding-ding-y' },
                    { type: 'result', label: 'Low - Ding Ding', id: 'bike-low-minus-ding' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('bike-high').value);
                    const low = parseFloat(document.getElementById('bike-low').value);

                    if (!isNaN(high) && !isNaN(low) && high >= 0 && low >= 0) {
                        const sqrtHighX = Math.sqrt(high);
                        const dingDingX = sqrtHighX * 0.2611;
                        const highPlusDingDing = high + dingDingX;
                        const sqrtLowY = Math.sqrt(low);
                        const dingDingY = sqrtLowY * 0.2611;
                        const lowMinusDingDing = low - dingDingY;

                        document.getElementById('bike-sqrt-high-x').textContent = sqrtHighX.toFixed(2);
                        document.getElementById('bike-ding-ding-x').textContent = dingDingX.toFixed(2);
                        document.getElementById('bike-high-plus-ding').textContent = highPlusDingDing.toFixed(2);
                        document.getElementById('bike-sqrt-low-y').textContent = sqrtLowY.toFixed(2);
                        document.getElementById('bike-ding-ding-y').textContent = dingDingY.toFixed(2);
                        document.getElementById('bike-low-minus-ding').textContent = lowMinusDingDing.toFixed(2);
                        return {
                            name: sheets.Bike.title,
                            date: new Date().toISOString(),
                            inputs: { 'High': high, 'Low': low },
                            results: { 'SQRT(High) "X"': sqrtHighX, 'Ding Ding (from "X")': dingDingX, 'High + Ding Ding': highPlusDingDing, 'SQRT(Low) "Y"': sqrtLowY, 'Ding Ding (from "Y")': dingDingY, 'Low - Ding Ding': lowMinusDingDing }
                        };
                    } else {
                        document.getElementById('bike-sqrt-high-x').textContent = '-';
                        document.getElementById('bike-ding-ding-x').textContent = '-';
                        document.getElementById('bike-high-plus-ding').textContent = '-';
                        document.getElementById('bike-sqrt-low-y').textContent = '-';
                        document.getElementById('bike-ding-ding-y').textContent = '-';
                        document.getElementById('bike-low-minus-ding').textContent = '-';
                        return null;
                    }
                }
            },
            Rikshaw: {
                title: "Rikshaw (5 Minutes Candle)",
                class: "rikshaw",
                fields: [
                    { type: 'input', label: '1st 5 Min Candles High', id: 'rikshaw-high' },
                    { type: 'input', label: '1st 5 Min Candles Low', id: 'rikshaw-low' },
                    { type: 'result', label: 'High + 0.2611%', id: 'rikshaw-high-plus-26' },
                    { type: 'result', label: 'High + 0.1306%', id: 'rikshaw-high-plus-13' },
                    { type: 'result', label: 'Low - 0.2611%', id: 'rikshaw-low-minus-26' },
                    { type: 'result', label: 'Low - 0.1306%', id: 'rikshaw-low-minus-13' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('rikshaw-high').value);
                    const low = parseFloat(document.getElementById('rikshaw-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const highPlus26 = high * (1 + 0.002611);
                        const highPlus13 = high * (1 + 0.001306);
                        const lowMinus26 = low * (1 - 0.002611);
                        const lowMinus13 = low * (1 - 0.001306);

                        document.getElementById('rikshaw-high-plus-26').textContent = highPlus26.toFixed(2);
                        document.getElementById('rikshaw-high-plus-13').textContent = highPlus13.toFixed(2);
                        document.getElementById('rikshaw-low-minus-26').textContent = lowMinus26.toFixed(2);
                        document.getElementById('rikshaw-low-minus-13').textContent = lowMinus13.toFixed(2);
                        return {
                            name: sheets.Rikshaw.title,
                            date: new Date().toISOString(),
                            inputs: { '1st 5 Min Candles High': high, '1st 5 Min Candles Low': low },
                            results: { 'High + 0.2611%': highPlus26, 'High + 0.1306%': highPlus13, 'Low - 0.2611%': lowMinus26, 'Low - 0.1306%': lowMinus13 }
                        };
                    } else {
                        document.getElementById('rikshaw-high-plus-26').textContent = '-';
                        document.getElementById('rikshaw-high-plus-13').textContent = '-';
                        document.getElementById('rikshaw-low-minus-26').textContent = '-';
                        document.getElementById('rikshaw-low-minus-13').textContent = '-';
                        return null;
                    }
                }
            },
            Car: {
                title: "Car (5 Minutes Candle, 1 Hour Time Frame)",
                class: "car",
                fields: [
                    { type: 'input', label: '1130-1230 High', id: 'car-high' },
                    { type: 'input', label: '1130-1230 Low', id: 'car-low' },
                    { type: 'result', label: 'Midpoint (High + Low) / 2', id: 'car-midpoint' },
                    { type: 'result', label: '1.5% Above Midpoint', id: 'car-above' },
                    { type: 'result', label: '1.5% Below Midpoint', id: 'car-below' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('car-high').value);
                    const low = parseFloat(document.getElementById('car-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const midpoint = (high + low) / 2;
                        const aboveMidpoint = midpoint * 1.015;
                        const belowMidpoint = midpoint * 0.985;

                        document.getElementById('car-midpoint').textContent = midpoint.toFixed(2);
                        document.getElementById('car-above').textContent = aboveMidpoint.toFixed(2);
                        document.getElementById('car-below').textContent = belowMidpoint.toFixed(2);
                        return { 
                            name: sheets.Car.title,
                            date: new Date().toISOString(),
                            inputs: { '1130-1230 High': high, '1130-1230 Low': low }, 
                            results: { 'Midpoint': midpoint, '1.5% Above Midpoint': aboveMidpoint, '1.5% Below Midpoint': belowMidpoint } 
                        };
                    } else {
                        document.getElementById('car-midpoint').textContent = '-';
                        document.getElementById('car-above').textContent = '-';
                        document.getElementById('car-below').textContent = '-';
                        return null;
                    }
                }
            },
            Pandavas: {
                title: "Pandavas (1/2 Day Candle, 195 Minutes)",
                class: "pandavas",
                fields: [
                    { type: 'input', label: "Yesterday's 1st Half High", id: 'pandavas-first-high' },
                    { type: 'input', label: "Yesterday's 1st Half Low", id: 'pandavas-first-low' },
                    { type: 'input', label: "Yesterday's 1st Half Close", id: 'pandavas-first-close' },
                    { type: 'input', label: "Yesterday's 2nd Half High", id: 'pandavas-second-high' },
                    { type: 'input', label: "Yesterday's 2nd Half Low", id: 'pandavas-second-low' },
                    { type: 'input', label: "Yesterday's 2nd Half Close", id: 'pandavas-second-close' },
                    { type: 'result', label: "Average 1 (Pivot)", id: 'pandavas-avg1' },
                    { type: 'result', label: "Average 2 (Pivot)", id: 'pandavas-avg2' },
                ],
                calculate: () => {
                    const values1 = [
                        parseFloat(document.getElementById('pandavas-first-high').value),
                        parseFloat(document.getElementById('pandavas-first-low').value),
                        parseFloat(document.getElementById('pandavas-first-close').value)
                    ];
                    const values2 = [
                        parseFloat(document.getElementById('pandavas-second-high').value),
                        parseFloat(document.getElementById('pandavas-second-low').value),
                        parseFloat(document.getElementById('pandavas-second-close').value)
                    ];

                    let avg1 = NaN;
                    let avg2 = NaN;
                    let validValues1 = values1.filter(val => !isNaN(val));
                    let validValues2 = values2.filter(val => !isNaN(val));

                    if (validValues1.length === 3) {
                        const sum = validValues1.reduce((acc, current) => acc + current, 0);
                        avg1 = sum / 3;
                    }
                    if (validValues2.length === 3) {
                        const sum = validValues2.reduce((acc, current) => acc + current, 0);
                        avg2 = sum / 3;
                    }

                    document.getElementById('pandavas-avg1').textContent = !isNaN(avg1) ? avg1.toFixed(2) : '-';
                    document.getElementById('pandavas-avg2').textContent = !isNaN(avg2) ? avg2.toFixed(2) : '-';
                    
                    if (!isNaN(avg1) && !isNaN(avg2)) {
                        return {
                            name: sheets.Pandavas.title,
                            date: new Date().toISOString(),
                            inputs: { "Yesterday's 1st Half High": values1[0], "Yesterday's 1st Half Low": values1[1], "Yesterday's 1st Half Close": values1[2], "Yesterday's 2nd Half High": values2[0], "Yesterday's 2nd Half Low": values2[1], "Yesterday's 2nd Half Close": values2[2] },
                            results: { "Average 1 (Pivot)": avg1, "Average 2 (Pivot)": avg2 }
                        };
                    } else {
                        return null;
                    }
                }
            },
            History: {
                title: "Saved History",
                class: "history",
                fields: [],
                calculate: () => {}, // No calculation for this sheet
            },
            Notes: {
                title: "Notes",
                class: "notes",
                fields: [],
                calculate: () => {}, // No calculation for this sheet
            }
        };

        const generateSheetHTML = (sheetName) => {
            const sheet = sheets[sheetName];
            let html = `
                <div class="tab-content bg-${sheet.class} bg-opacity-20 p-6 rounded-lg transition-colors duration-300">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-${sheet.class}">${sheet.title}</h2>
            `;

            if (['Umbrella', 'Bike', 'Rikshaw', 'Car', 'Pandavas'].includes(sheetName)) {
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4">
                `;
                // Render input fields on the left
                sheet.fields.filter(f => f.type === 'input').forEach(field => {
                    html += renderInputField(field.label, field.id);
                });
                html += `
                        </div>
                        <div class="grid grid-cols-1 gap-4 self-start">
                `;
                // Render result fields on the right
                sheet.fields.filter(f => f.type === 'result').forEach(field => {
                    html += renderResultField(field.label, field.id);
                });
                html += `
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button id="save-calculation" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">
                            <i class="fas fa-save mr-2"></i>Save Calculation
                        </button>
                    </div>
                `;
            } else if (sheetName === 'History') {
                html += `
                    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
                        <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">
                            <i class="fas fa-file-csv mr-2"></i>Export as CSV
                        </button>
                        <button id="copy-history" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">
                            <i class="fas fa-copy mr-2"></i>Copy All
                        </button>
                    </div>
                    <div class="history-table-container bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rule</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Results</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- History items will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-history-message" class="text-center text-gray-500 italic p-4 mt-4 hidden">
                        No saved calculations yet.
                    </div>
                `;
            } else if (sheetName === 'Notes') {
                html += `
                    <textarea id="notes-textarea" class="w-full h-80 p-4 text-sm rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" placeholder="Write your notes here..."></textarea>
                `;
            }

            html += `</div>`;
            return html;
        };

        const renderHistoryTable = () => {
            const tableBody = document.getElementById('history-table-body');
            const emptyMessage = document.getElementById('empty-history-message');
            if (tableBody) {
                tableBody.innerHTML = '';
                if (window.app.state.calculations.length === 0) {
                    emptyMessage.classList.remove('hidden');
                    return;
                }
                emptyMessage.classList.add('hidden');

                window.app.state.calculations.forEach((calc, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'history-item hover:bg-gray-100 dark:hover:bg-gray-700';
                    tr.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                            ${new Date(calc.date).toLocaleString()}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            ${calc.name}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-300">
                            ${Object.entries(calc.results).map(([key, value]) => `<strong>${key}:</strong> ${value.toFixed(2)}`).join('<br>')}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium">
                            <button class="delete-history-btn text-red-600 hover:text-red-900" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        };

        const handleSaveCalculation = () => {
            const currentSheet = sheets[window.app.state.activeSheet];
            const calculation = currentSheet.calculate();
            if (calculation) {
                // Add a unique ID for easy deletion
                calculation.id = Date.now();
                window.app.state.calculations.unshift(calculation); // Add to the top
                saveToLocalStorage();
                showMessage('Calculation saved successfully!');
            } else {
                showMessage('Please fill in all inputs to save.', 'error');
            }
        };

        const handleDeleteCalculation = (index) => {
            if (confirm('Are you sure you want to delete this calculation?')) {
                window.app.state.calculations.splice(index, 1);
                saveToLocalStorage();
                renderHistoryTable();
                showMessage('Calculation deleted.');
            }
        };

        const exportToCsv = () => {
            if (window.app.state.calculations.length === 0) {
                showMessage('No data to export.', 'error');
                return;
            }

            const header = "Date,Rule," + Object.keys(window.app.state.calculations[0].inputs).join(',') + "," + Object.keys(window.app.state.calculations[0].results).join(',') + "\n";
            let csv = header;
            window.app.state.calculations.forEach(calc => {
                const inputs = Object.values(calc.inputs).join(',');
                const results = Object.values(calc.results).map(r => r.toFixed(2)).join(',');
                csv += `${new Date(calc.date).toLocaleString()},"${calc.name}",${inputs},${results}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "trading_rules_history.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('History exported as CSV!');
            }
        };

        const copyHistoryToClipboard = () => {
            if (window.app.state.calculations.length === 0) {
                showMessage('No data to copy.', 'error');
                return;
            }

            const header = "Date,Rule," + Object.keys(window.app.state.calculations[0].inputs).join('\t') + "\t" + Object.keys(window.app.state.calculations[0].results).join('\t') + "\n";
            let text = header;
            window.app.state.calculations.forEach(calc => {
                const inputs = Object.values(calc.inputs).join('\t');
                const results = Object.values(calc.results).map(r => r.toFixed(2)).join('\t');
                text += `${new Date(calc.date).toLocaleString()}\t${calc.name}\t${inputs}\t${results}\n`;
            });
            copyToClipboard(text);
        };
        
        // Function to render the active sheet
        const renderSheet = () => {
            const sheetContentDiv = document.getElementById('sheet-content');
            const sheetName = window.app.state.activeSheet;
            sheetContentDiv.innerHTML = generateSheetHTML(sheetName);

            if (sheetName === 'Notes') {
                const notesTextarea = document.getElementById('notes-textarea');
                notesTextarea.value = window.app.state.notes;
                // Save notes with a debounce to prevent excessive saving on every keystroke
                notesTextarea.addEventListener('input', debounce((e) => {
                    window.app.state.notes = e.target.value;
                    saveToLocalStorage();
                }, 500));
            } else if (sheetName === 'History') {
                renderHistoryTable();
                // Add event listener for delete buttons
                document.getElementById('history-table-body').addEventListener('click', (e) => {
                    if (e.target.closest('.delete-history-btn')) {
                        const index = e.target.closest('.delete-history-btn').dataset.index;
                        handleDeleteCalculation(index);
                    }
                });
                document.getElementById('export-csv').addEventListener('click', exportToCsv);
                document.getElementById('copy-history').addEventListener('click', copyHistoryToClipboard);
            } else { // It's a calculator sheet
                const currentSheet = sheets[sheetName];
                const inputFields = currentSheet.fields.filter(f => f.type === 'input');
                const calculateDebounced = debounce(currentSheet.calculate, 300);

                inputFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (input) {
                        input.addEventListener('input', calculateDebounced);
                    }
                });

                // Add event listener for the save button on calculator tabs
                const saveButton = document.getElementById('save-calculation');
                if (saveButton) {
                    saveButton.addEventListener('click', handleSaveCalculation);
                }
            }
        };

        // Quote fetching function
        const fetchQuote = async () => {
            const quoteDiv = document.getElementById('daily-quote');
            try {
                const response = await fetch('https://api.quotable.io/random');
                if (!response.ok) {
                    throw new Error('Failed to fetch quote');
                }
                const data = await response.json();
                quoteDiv.innerHTML = `<p>"${data.content}"<br>- ${data.author}</p>`;
            } catch (error) {
                console.error("Error fetching quote:", error);
                quoteDiv.innerHTML = `<p>"The only way to do great work is to love what you do."<br>- Steve Jobs</p>`;
            }
        };

        // Theme toggle function
        const toggleTheme = () => {
            const body = document.body;
            const toggleIcon = document.getElementById('toggle-icon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
                window.app.state.theme = 'light';
            } else {
                body.setAttribute('data-theme', 'dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
                window.app.state.theme = 'dark';
            }
        };

        // Event listeners for tab navigation
        const setupTabListeners = () => {
            const tabButtons = document.querySelectorAll('#tab-navigation .tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to the clicked button
                    button.classList.add('active');
                    // Update global state and render the new sheet
                    window.app.state.activeSheet = button.getAttribute('data-sheet');
                    renderSheet();
                });
            });
        };
        
        // Modal functions
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const closeModalButton = document.getElementById('close-modal');

        const openModal = () => {
            helpModal.classList.remove('hidden');
            setTimeout(() => {
                helpModal.classList.add('active');
            }, 10); // Small delay for CSS transition
        };

        const closeModal = () => {
            helpModal.classList.remove('active');
            setTimeout(() => {
                helpModal.classList.add('hidden');
            }, 300); // Wait for transition to finish
        };

        // Initial setup on page load
        window.onload = () => {
            loadFromLocalStorage();
            renderSheet(); // Render the initial sheet (Umbrella)
            setupTabListeners();
            fetchQuote();

            // Set up theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', toggleTheme);
            const body = document.body;
            const toggleIcon = document.getElementById('toggle-icon');
            if (window.app.state.theme === 'light') {
                body.setAttribute('data-theme', 'light');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
            } else {
                body.setAttribute('data-theme', 'dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
            }

            // Set up help modal listeners
            helpButton.addEventListener('click', openModal);
            closeModalButton.addEventListener('click', closeModal);
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    closeModal();
                }
            });
        };

    </script>
</body>
</html>
