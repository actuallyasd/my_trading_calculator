<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Rules Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    :root { --ios-radius: 14px; --glass: rgba(255,255,255,0.06); }
    html,body { height:100%; }
    body {
      font-family:'Inter',sans-serif;
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background 0.25s ease, color 0.25s ease;
    }

    /* ---------- textured backgrounds (subtle, offline) ---------- */
    body[data-theme='dark'] {
      background-color:#0d1117;
      background-image:
        radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.0));
      background-size: 8px 8px, 100% 100%;
      color: #f8fafc;
    }
    body[data-theme='light'] {
      background-color:#f3f4f6;
      background-image:
        radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
        linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
      background-size: 10px 10px, 100% 100%;
      color: #0f172a;
    }

    /* ---------- app frame (centered & iOS feel) ---------- */
    .app-frame { width:100%; max-width:1100px; margin: 2rem auto; padding: 0 1rem; }
    .bg-container {
      border-radius: var(--ios-radius);
      padding: 1.25rem;
      transition: box-shadow 0.25s ease, background 0.25s ease;
      backdrop-filter: blur(6px);
    }
    body[data-theme='dark'] .bg-container {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 12px 30px rgba(2,6,23,0.6);
    }
    body[data-theme='light'] .bg-container {
      background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.95));
      box-shadow: 0 10px 28px rgba(16,24,40,0.06);
    }

    /* ---------- header quote bar (fixed, small, expandable) ---------- */
    #quote-bar {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      width: min(980px, calc(100% - 2rem));
      z-index: 999;
      border-radius: 12px;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      transition: transform 0.28s ease, height 0.28s ease, padding 0.28s ease;
      cursor: pointer;
      user-select: none;
    }
    body[data-theme='dark'] #quote-bar {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
      color: #e6eefc;
    }
    body[data-theme='light'] #quote-bar {
      background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
      border: 1px solid rgba(0,0,0,0.04);
      color: #0f172a;
    }
    #quote-bar .quote-text { font-size:0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 120px); }
    #quote-bar .quote-actions { display:flex; gap:0.5rem; align-items:center; }
    #quote-bar.expanded { padding:1rem; white-space:normal; cursor:default; }
    #quote-bar.expanded .quote-text { white-space: normal; max-height: 6rem; overflow:auto; }

    /* ---------- main layout ---------- */
    .header-actions { display:flex; gap:0.5rem; align-items:center; }
    .tab-button { transition: all 0.22s ease; border-radius: 9999px; padding: 0.55rem 0.9rem; font-weight:600; }
    .tab-button.active { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
    body[data-theme='dark'] .tab-button { background:#2f3740; color:#d1d5db; }
    body[data-theme='light'] .tab-button { background:#f2f4f7; color:#475569; }

    /* result boxes / inputs */
    .result-field > div { border-radius: 12px; padding: 0.9rem; }
    body[data-theme='dark'] .result-field > div { background: #111827; color: #f8fafc; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 6px 18px rgba(2,6,23,0.45);}
    body[data-theme='light'] .result-field > div { background: #ffffff; color:#0f172a; border:1px solid rgba(0,0,0,0.04); box-shadow: 0 6px 20px rgba(16,24,40,0.04); }

    /* help modal */
    .modal-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.6); z-index:1200; opacity:0; visibility:hidden; transition:opacity .2s ease; }
    .modal-overlay.active { opacity:1; visibility:visible; }
    .modal-card { border-radius: 12px; padding:1.25rem; width: min(720px, 94%); max-height: 92vh; overflow:auto; }

    /* image reference modal */
    #ref-modal .img-wrap { display:flex; justify-content:center; align-items:center; }
    #ref-modal img { max-width:100%; border-radius:10px; }

    /* share buttons */
    .share-btn { padding:0.55rem 0.9rem; border-radius:9999px; display:inline-flex; gap:0.5rem; align-items:center; }

    /* history table */
    .history-table-container { max-height:36vh; overflow:auto; border-radius:10px; }

    /* smooth minimal animations */
    .fade-in { animation: fadeIn 240ms ease both; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:none; } }

    /* small utilities */
    .mini { font-size:0.85rem; }
    .muted { opacity:0.7; font-size:0.9rem; }
    /* responsive tweak so top fixed quote doesn't cover content with smaller viewports */
    .header-spacer { height: 3.5rem; } /* reserved vertical space for quote bar */
    @media (max-width:640px) { .header-spacer { height: 4.75rem; } #quote-bar .quote-text { max-width: calc(100% - 100px); } }

  </style>
</head>
<body data-theme="dark">
  <!-- TOP QUOTE BAR (fixed & expandable) -->
  <div id="quote-bar" class="fade-in" role="region" aria-live="polite">
    <div class="quote-text" id="quote-text">Loading today's trader quoteâ€¦</div>
    <div class="quote-actions">
      <button id="quote-copy" title="Copy quote" class="mini muted"><i class="fas fa-copy"></i></button>
      <button id="quote-expand" title="Expand quote" class="mini muted"><i class="fas fa-chevron-down"></i></button>
    </div>
  </div>

  <!-- spacer to prevent content behind fixed bar -->
  <div class="header-spacer"></div>

  <div class="app-frame">
    <div class="bg-container">
      <!-- header actions -->
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-3xl sm:text-4xl font-extrabold text-main">Trading Rules Calculator</h1>
          <p class="muted mini mt-1">Enter your values; results update automatically. Click the quote to expand for a longer tip.</p>
        </div>
        <div class="header-actions">
          <button id="help-button" class="tab-button"><i class="fas fa-question"></i></button>
          <button id="theme-toggle" class="tab-button" title="Toggle theme"><i id="toggle-icon" class="fas fa-sun"></i></button>
        </div>
      </div>

      <!-- tabs -->
      <div id="tab-navigation" class="flex flex-wrap gap-2 mb-6">
        <button class="tab-button active" data-sheet="Umbrella">Umbrella</button>
        <button class="tab-button" data-sheet="Bike">Bike</button>
        <button class="tab-button" data-sheet="Rikshaw">Rikshaw</button>
        <button class="tab-button" data-sheet="Car">Car</button>
        <button class="tab-button" data-sheet="Pandavas">Pandavas</button>
        <button class="tab-button" data-sheet="History">History</button>
        <button class="tab-button" data-sheet="Notes">Notes</button>
      </div>

      <!-- main content -->
      <div id="sheet-content" class="fade-in"></div>

      <!-- share / invite -->
      <div class="mt-6 pt-6 border-t">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <strong>Share this calculator</strong>
            <div class="muted mini">Invite others or copy a shareable link</div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button id="share-whatsapp" class="share-btn bg-green-500 text-white"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            <button id="share-telegram" class="share-btn bg-blue-500 text-white"><i class="fab fa-telegram-plane"></i> Telegram</button>
            <button id="copy-link" class="share-btn bg-gray-600 text-white"><i class="fas fa-link"></i> Copy Link</button>
            <button id="open-ref" class="share-btn bg-indigo-500 text-white"><i class="fas fa-image"></i> Reference Image</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- small footer help / telegram -->
  <div class="app-frame mt-4">
    <div class="flex justify-center">
      <a href="https://t.me/Mathstrade" target="_blank" rel="noopener" class="muted mini">Connect on Telegram</a>
    </div>
  </div>

  <!-- Reference image modal -->
  <div id="ref-modal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal-card bg-container">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold">Reference: 5 Steps</h3>
        <div class="flex gap-2 items-center">
          <label class="mini muted">Replace image</label>
          <input id="ref-upload" type="file" accept="image/*" class="mini" />
          <button id="ref-close" class="tab-button"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="img-wrap">
        <!-- You can replace src by uploading a local file. Default placeholder below. -->
        <img id="ref-image" src="" alt="Reference steps (click open to upload)" />
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="help-modal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal-card">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold">How it works</h3>
        <button id="help-close" class="tab-button"><i class="fas fa-times"></i></button>
      </div>
      <div class="mt-4 muted">
        <p class="mb-2">- Tabs represent different rules. Enter the numeric values and the results populate automatically.</p>
        <p class="mb-2">- Save calculations in <strong>History</strong>. Export CSV or copy it. CSV export is sanitized (proper quoting) so columns don't break.</p>
        <p class="mb-2">- Click <strong>Reference Image</strong> to view or replace the 5-step guide.</p>
        <p class="mb-2">- Use <strong>Analyze</strong> in History to produce a quick on-device summary of saved calculations (not a live AI call).</p>
      </div>
    </div>
  </div>

  <!-- Message box -->
  <div id="message-box" style="position:fixed;right:1rem;bottom:1.25rem;z-index:1400;display:none;padding:.75rem 1rem;border-radius:8px;background:#16a34a;color:white;"></div>

<script>
/* =========================
   Keep core functionality unchanged
   Add UI polish, quote bar, image modal, sharing, CSV fixes, and a simple analyze feature.
   ========================= */

// --- Minimal helpers ---
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
const showMsg = (t, ms=2200) => {
  const el = document.getElementById('message-box');
  el.textContent = t; el.style.display='block';
  setTimeout(()=> el.style.display='none', ms);
};
const escapeCsv = (value) => {
  if (value === null || value === undefined) return '';
  const s = String(value);
  if (s.includes('"') || s.includes(',') || s.includes('\n')) {
    return `"${s.replace(/"/g,'""')}"`;
  }
  return s;
};

// --- App state (keeps compatibility with your saved data keys) ---
const app = {
  theme: document.body.getAttribute('data-theme') || 'dark',
  activeSheet: 'Umbrella',
  calculations: [], // objects saved from sheets
  quote: null,
  refImageDataUrl: null
};

// --- Sheets definitions (kept behavior same as original, but modular rendering) ---
const sheets = {
  Umbrella: {
    title: 'Umbrella (Daily Candle)',
    inputs: [
      {id:'umbrella-high', label:'Previous Day High'}, {id:'umbrella-low', label:'Previous Day Low'}
    ],
    results: [
      {id:'umbrella-range', label:'Range (High - Low)'}, {id:'umbrella-x', label:'"X" (Range * 26.11%)'},
      {id:'umbrella-high-minus-x', label:'High - "X"'}, {id:'umbrella-low-plus-x', label:'Low + "X"'}
    ],
    calculate: function(){
      const high = parseFloat($('#umbrella-high')?.value);
      const low = parseFloat($('#umbrella-low')?.value);
      if (!isNaN(high) && !isNaN(low)) {
        const range = high - low;
        const x = range * 0.2611;
        $('#umbrella-range').textContent = range.toFixed(2);
        $('#umbrella-x').textContent = x.toFixed(2);
        $('#umbrella-high-minus-x').textContent = (high - x).toFixed(2);
        $('#umbrella-low-plus-x').textContent = (low + x).toFixed(2);
        return { name: this.title, date: new Date().toISOString(), inputs: {high, low}, results:{range, x, highMinusX: high-x, lowPlusX: low+x} };
      } else {
        this.results.forEach(r=> $('#'+r.id).textContent = '-');
        return null;
      }
    }
  },
  Bike: {
    title: 'Bike (1/2 Day Candle, 195 Minutes)',
    inputs: [{id:'bike-high',label:'High'},{id:'bike-low',label:'Low'}],
    results: [{id:'bike-sqrt-high-x',label:'SQRT(High) "X"'},{id:'bike-ding-ding-x',label:'Ding Ding (from "X")'},{id:'bike-high-plus-ding',label:'High + Ding Ding'},
              {id:'bike-sqrt-low-y',label:'SQRT(Low) "Y"'},{id:'bike-ding-ding-y',label:'Ding Ding (from "Y")'},{id:'bike-low-minus-ding',label:'Low - Ding Ding'}],
    calculate: function(){
      const high = parseFloat($('#bike-high')?.value);
      const low = parseFloat($('#bike-low')?.value);
      if (!isNaN(high) && !isNaN(low) && high>=0 && low>=0) {
        const sqrtHighX = Math.sqrt(high);
        const dingDingX = sqrtHighX * 0.2611;
        const highPlus = high + dingDingX;
        const sqrtLowY = Math.sqrt(low);
        const dingDingY = sqrtLowY * 0.2611;
        const lowMinus = low - dingDingY;
        $('#bike-sqrt-high-x').textContent = sqrtHighX.toFixed(2);
        $('#bike-ding-ding-x').textContent = dingDingX.toFixed(2);
        $('#bike-high-plus-ding').textContent = highPlus.toFixed(2);
        $('#bike-sqrt-low-y').textContent = sqrtLowY.toFixed(2);
        $('#bike-ding-ding-y').textContent = dingDingY.toFixed(2);
        $('#bike-low-minus-ding').textContent = lowMinus.toFixed(2);
        return {name:this.title,date:new Date().toISOString(),inputs:{high,low},results:{sqrtHighX,dingDingX,highPlus,sqrtLowY,dingDingY,lowMinus}};
      } else {
        this.results.forEach(r=> $('#'+r.id).textContent='-');
        return null;
      }
    }
  },
  Rikshaw: {
    title:'Rikshaw (5 Minutes Candle)',
    inputs:[{id:'rikshaw-high',label:'1st 5 Min Candles High'},{id:'rikshaw-low',label:'1st 5 Min Candles Low'}],
    results:[{id:'rikshaw-high-plus-26',label:'High + 0.2611%'},{id:'rikshaw-high-plus-13',label:'High + 0.1306%'},
             {id:'rikshaw-low-minus-26',label:'Low - 0.2611%'},{id:'rikshaw-low-minus-13',label:'Low - 0.1306%'}],
    calculate:function(){
      const high = parseFloat($('#rikshaw-high')?.value);
      const low = parseFloat($('#rikshaw-low')?.value);
      if(!isNaN(high)&&!isNaN(low)){
        const highPlus26 = high * (1 + 0.002611);
        const highPlus13 = high * (1 + 0.001306);
        const lowMinus26 = low * (1 - 0.002611);
        const lowMinus13 = low * (1 - 0.001306);
        $('#rikshaw-high-plus-26').textContent = highPlus26.toFixed(2);
        $('#rikshaw-high-plus-13').textContent = highPlus13.toFixed(2);
        $('#rikshaw-low-minus-26').textContent = lowMinus26.toFixed(2);
        $('#rikshaw-low-minus-13').textContent = lowMinus13.toFixed(2);
        return {name:this.title,date:new Date().toISOString(),inputs:{high,low},results:{highPlus26,highPlus13,lowMinus26,lowMinus13}};
      } else {
        this.results.forEach(r=> $('#'+r.id).textContent='-'); return null;
      }
    }
  },
  Car: {
    title:'Car (5 Minutes Candle, 1 Hour Time Frame)',
    inputs:[{id:'car-high',label:'1130-1230 High'},{id:'car-low',label:'1130-1230 Low'}],
    results:[{id:'car-midpoint',label:'Midpoint (High + Low) / 2'},{id:'car-above',label:'1.5% Above Midpoint'},{id:'car-below',label:'1.5% Below Midpoint'}],
    calculate:function(){
      const high = parseFloat($('#car-high')?.value);
      const low = parseFloat($('#car-low')?.value);
      if(!isNaN(high)&&!isNaN(low)){
        const midpoint = (high+low)/2;
        const above = midpoint*1.015; const below = midpoint*0.985;
        $('#car-midpoint').textContent = midpoint.toFixed(2);
        $('#car-above').textContent = above.toFixed(2);
        $('#car-below').textContent = below.toFixed(2);
        return {name:this.title,date:new Date().toISOString(),inputs:{high,low},results:{midpoint,above,below}};
      } else { this.results.forEach(r=>$('#'+r.id).textContent='-'); return null; }
    }
  },
  Pandavas: {
    title:'Pandavas (1/2 Day Candle, 195 Minutes)',
    inputs:[
      {id:'pandavas-first-high',label:"Yesterday's 1st Half High"},
      {id:'pandavas-first-low',label:"Yesterday's 1st Half Low"},
      {id:'pandavas-first-close',label:"Yesterday's 1st Half Close"},
      {id:'pandavas-second-high',label:"Yesterday's 2nd Half High"},
      {id:'pandavas-second-low',label:"Yesterday's 2nd Half Low"},
      {id:'pandavas-second-close',label:"Yesterday's 2nd Half Close"}
    ],
    results:[{id:'pandavas-avg1',label:'Average 1 (Pivot)'},{id:'pandavas-avg2',label:'Average 2 (Pivot)'}],
    calculate:function(){
      const v1 = [parseFloat($('#pandavas-first-high')?.value),parseFloat($('#pandavas-first-low')?.value),parseFloat($('#pandavas-first-close')?.value)];
      const v2 = [parseFloat($('#pandavas-second-high')?.value),parseFloat($('#pandavas-second-low')?.value),parseFloat($('#pandavas-second-close')?.value)];
      const valid1 = v1.filter(v=>!isNaN(v)), valid2 = v2.filter(v=>!isNaN(v));
      let avg1 = NaN, avg2 = NaN;
      if(valid1.length===3){ avg1 = valid1.reduce((a,b)=>a+b,0)/3; $('#pandavas-avg1').textContent=avg1.toFixed(2); } else $('#pandavas-avg1').textContent='-';
      if(valid2.length===3){ avg2 = valid2.reduce((a,b)=>a+b,0)/3; $('#pandavas-avg2').textContent=avg2.toFixed(2); } else $('#pandavas-avg2').textContent='-';
      if(!isNaN(avg1) && !isNaN(avg2)) return {name:this.title,date:new Date().toISOString(),inputs:{v1,v2},results:{avg1,avg2}};
      return null;
    }
  }
};

// --- Rendering helpers: render sheet UI (inputs & results) without changing behavior ---
function buildSheetHtml(sheetName){
  if(!sheets[sheetName]) return '<div></div>';
  const s = sheets[sheetName];
  if(sheetName === 'History'){
    return `
      <div>
        <div class="flex gap-3 mb-3">
          <button id="analyze-history" class="share-btn bg-indigo-600 text-white"><i class="fas fa-brain"></i> Analyze</button>
          <button id="export-csv" class="share-btn bg-green-600 text-white"><i class="fas fa-file-csv"></i> Export CSV</button>
          <button id="copy-all" class="share-btn bg-gray-600 text-white"><i class="fas fa-copy"></i> Copy</button>
          <button id="clear-history" class="share-btn bg-red-600 text-white"><i class="fas fa-trash"></i> Clear</button>
        </div>
        <div class="history-table-container bg-white dark:bg-gray-800 rounded p-3">
          <table class="min-w-full">
            <thead><tr>
              <th class="text-left mini muted">Date</th>
              <th class="text-left mini muted">Rule</th>
              <th class="text-left mini muted">Results</th>
              <th class="text-center mini muted">Actions</th>
            </tr></thead>
            <tbody id="history-table-body"></tbody>
          </table>
        </div>
        <div id="analysis-output" class="mt-3"></div>
      </div>
    `;
  }
  if(sheetName === 'Notes'){
    return `<textarea id="notes-textarea" class="w-full h-56 p-3 rounded border" placeholder=" jot notes... "></textarea>`;
  }

  // regular calculator sheet
  const leftInputs = s.inputs.map(i=>`
    <div class="mb-3">
      <label class="mini muted">${i.label}</label>
      <input id="${i.id}" type="number" step="0.01" class="w-full rounded p-2 border" />
    </div>
  `).join('');
  const rightResults = s.results.map(r=>`
    <div class="result-field mb-3">
      <div class="text-xs muted">${r.label}</div>
      <div id="${r.id}" class="text-lg font-bold mt-1">-</div>
    </div>
  `).join('');
  return `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>${leftInputs}</div>
      <div>${rightResults}</div>
    </div>
    <div class="flex justify-center mt-4">
      <button id="save-calculation" class="bg-blue-600 text-white rounded-full py-2 px-6"><i class="fas fa-save mr-2"></i> Save Calculation</button>
    </div>
  `;
}

// --- rendering / wiring up sheet events ---
function renderActiveSheet(){
  const target = $('#sheet-content');
  target.innerHTML = buildSheetHtml(app.activeSheet);
  if(app.activeSheet === 'History') {
    renderHistoryTable();
    $('#export-csv').addEventListener('click', exportHistoryCsv);
    $('#copy-all').addEventListener('click', copyHistoryText);
    $('#clear-history').addEventListener('click', clearHistory);
    $('#analyze-history').addEventListener('click', analyzeHistory);
  } else if (app.activeSheet === 'Notes') {
    const ta = $('#notes-textarea');
    ta.value = localStorage.getItem('notes') || '';
    ta.addEventListener('input', debounce(()=> localStorage.setItem('notes', ta.value), 400));
  } else {
    // attach inputs -> calculate
    const sheet = sheets[app.activeSheet];
    if(!sheet) return;
    sheet.inputs.forEach(i => {
      const input = $('#'+i.id);
      if(input){
        input.addEventListener('input', debounce(()=> { try{ sheet.calculate(); }catch{} }, 260));
        // restore saved value if present (compatibility with previous storage key)
        const savedKey = `trading-calc-${app.activeSheet}`;
        try {
          const saved = JSON.parse(localStorage.getItem(savedKey) || '{}');
          if(saved && saved[input.id]) input.value = saved[input.id];
        } catch(e){ /* ignore */ }
      }
    });
    // ensure results are computed with any restored values
    try { sheet.calculate(); } catch(e){ /* ignore */ }

    // save button
    const sb = $('#save-calculation');
    if(sb) sb.addEventListener('click', () => {
      const calc = sheet.calculate();
      if(calc){
        // add a friendly timestamp & sanitized name (no commas or newline)
        calc.name = calc.name.replace(/,/g,' ');
        calc.date = new Date().toISOString();
        app.calculations.unshift(calc);
        persistCalculations();
        renderHistoryTable();
        showMsg('Saved to history');
      } else showMsg('Fill required inputs first', 2000);
    });
  }
  // wire up Load/Delete action delegation for history table (below)
}

// --- history persistence & rendering ---
function persistCalculations(){ localStorage.setItem('calculations_v2', JSON.stringify(app.calculations)); }
function loadCalculations(){ try{ app.calculations = JSON.parse(localStorage.getItem('calculations_v2')||'[]') }catch(e){ app.calculations = []; } }
function renderHistoryTable(){
  loadCalculations();
  const body = $('#history-table-body');
  if(!body) return;
  body.innerHTML = '';
  if(app.calculations.length===0){ body.innerHTML = '<tr><td colspan="4" class="muted mini p-3">No saved calculations yet.</td></tr>'; return; }
  app.calculations.forEach((c, idx)=>{
    const date = new Date(c.date).toLocaleString();
    // render results as key: value lines, but avoid commas breaking CSV by using plain text here
    const resultsText = Object.entries(c.results).map(([k,v]) => `${k}: ${Number(v).toFixed(2)}`).join('<br/>');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-3 mini">${escapeHtml(date)}</td>
      <td class="p-3 mini">${escapeHtml(c.name)}</td>
      <td class="p-3 mini">${resultsText}</td>
      <td class="p-3 text-center"><button class="delete-btn mini" data-idx="${idx}"><i class="fas fa-trash-alt"></i></button></td>
    `;
    body.appendChild(tr);
  });
  // attach delete delegation
  body.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (ev)=>{
    const idx = Number(ev.currentTarget.dataset.idx);
    if(confirm('Delete this saved calculation?')) { app.calculations.splice(idx,1); persistCalculations(); renderHistoryTable(); showMsg('Deleted'); }
  }));
}

// --- CSV export (sanitized) ---
function exportHistoryCsv(){
  loadCalculations();
  if(app.calculations.length === 0){ showMsg('No history to export', 1800); return; }
  // Build comprehensive header: Timestamp, Rule, (inputs...), (results...)
  // Collect union of input/result keys
  const allInputs = new Set(), allResults = new Set();
  app.calculations.forEach(c => {
    Object.keys(c.inputs || {}).forEach(k => allInputs.add(k));
    Object.keys(c.results || {}).forEach(k => allResults.add(k));
  });
  const header = ['Timestamp','Rule',...Array.from(allInputs),...Array.from(allResults)];
  let csv = header.map(h=>escapeCsv(h)).join(',') + '\n';
  app.calculations.forEach(c => {
    const row = [];
    row.push(escapeCsv(new Date(c.date).toLocaleString()));
    row.push(escapeCsv(c.name));
    Array.from(allInputs).forEach(k => row.push(escapeCsv((c.inputs && c.inputs[k]) ?? '')));
    Array.from(allResults).forEach(k => {
      const v = (c.results && c.results[k]);
      row.push(escapeCsv((v===undefined || v===null) ? '' : Number(v).toFixed(2)));
    });
    csv += row.join(',') + '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.href = url; link.download = 'trading_history.csv';
  document.body.appendChild(link); link.click(); link.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
  showMsg('CSV exported');
}

function copyHistoryText(){
  loadCalculations();
  if(app.calculations.length === 0){ showMsg('No history to copy'); return; }
  let text = 'Timestamp\tRule\tInputs\tResults\n';
  app.calculations.forEach(c=>{
    const inputs = Object.entries(c.inputs || {}).map(([k,v]) => `${k}: ${v}`).join('; ');
    const results = Object.entries(c.results || {}).map(([k,v]) => `${k}: ${Number(v).toFixed(2)}`).join('; ');
    text += `${new Date(c.date).toLocaleString()}\t${c.name}\t${inputs}\t${results}\n`;
  });
  navigator.clipboard?.writeText(text).then(()=> showMsg('History copied to clipboard')).catch(()=> showMsg('Failed to copy'));
}

function clearHistory(){
  if(confirm('Clear all saved history?')){ app.calculations = []; persistCalculations(); renderHistoryTable(); showMsg('History cleared'); }
}

// --- Analyze (simple on-device summary) ---
function analyzeHistory(){
  loadCalculations();
  const out = $('#analysis-output');
  if(!out) return;
  if(app.calculations.length === 0){ out.innerHTML = '<div class="muted mini">No data to analyze.</div>'; return; }
  // Basic heuristic: for each numeric result key, compute average and direction hint
  const aggregates = {}; let count=0;
  app.calculations.forEach(c=>{
    count++;
    Object.entries(c.results || {}).forEach(([k,v])=>{
      if(typeof v === 'number' && !isNaN(v)){
        aggregates[k] = aggregates[k] || {sum:0, min:Infinity, max:-Infinity, n:0};
        aggregates[k].sum += v;
        aggregates[k].n += 1;
        aggregates[k].min = Math.min(aggregates[k].min, v);
        aggregates[k].max = Math.max(aggregates[k].max, v);
      }
    });
  });
  // Compose simple recommendations
  let html = '<div class="p-3 rounded border muted">';
  html += '<strong>Quick analysis</strong> <div class="mini">(on-device heuristics, not financial advice)</div><br/>';
  html += `<div class="mt-2">Saved entries: <strong>${app.calculations.length}</strong></div>`;
  html += '<ul class="mt-2">';
  for(const [k,v] of Object.entries(aggregates)){
    const avg = v.sum / v.n;
    const range = v.max - v.min;
    let pointer = 'Stable';
    if(range / (Math.abs(avg)||1) > 0.01) pointer = 'Variable';
    html += `<li><strong>${escapeHtml(k)}</strong>: avg ${avg.toFixed(2)} â€” ${pointer} (min ${v.min.toFixed(2)}, max ${v.max.toFixed(2)})</li>`;
  }
  html += '</ul>';
  html += '<div class="mt-3"><em class="mini">Suggestion:</em> review frequently occurring pivots and consider weighting more-recent samples. <strong>Not financial advice.</strong></div>';
  html += '</div>';
  out.innerHTML = html;
}

// --- quote fetching and UI ---
async function loadQuote(){
  const qEl = $('#quote-text');
  try {
    // try public quotes endpoint; fallback to local hardcoded if blocked
    const res = await fetch('https://api.quotable.io/random');
    if(!res.ok) throw new Error('Quote fetch failed');
    const data = await res.json();
    app.quote = `${data.content} â€” ${data.author}`;
  } catch(e){
    app.quote = 'Discipline > emotion. Trade the plan, not the noise. â€” Trading reminder';
  }
  qEl.textContent = app.quote;
  $('#quote-copy').addEventListener('click', ()=> { navigator.clipboard?.writeText(app.quote); showMsg('Quote copied'); });
}

// quote expand/collapse
$('#quote-bar').addEventListener('click', (e)=>{
  const qb = $('#quote-bar');
  // ignore if clicking the copy button
  if(e.target.id === 'quote-copy') return;
  const expanded = qb.classList.toggle('expanded');
  $('#quote-expand').innerHTML = expanded ? '<i class="fas fa-chevron-up"></i>' : '<i class="fas fa-chevron-down"></i>';
});

// --- image reference modal handling ---
const refModal = $('#ref-modal');
const refImage = $('#ref-image');
$('#open-ref').addEventListener('click', ()=> {
  refModal.classList.remove('hidden'); refModal.classList.add('active'); refModal.setAttribute('aria-hidden','false');
  // if no image yet, show placeholder
  if(!app.refImageDataUrl) {
    refImage.src = dataUriPlaceholder();
  } else refImage.src = app.refImageDataUrl;
});
$('#ref-close').addEventListener('click', ()=> { refModal.classList.remove('active'); setTimeout(()=>{ refModal.classList.add('hidden'); refModal.setAttribute('aria-hidden','true'); }, 200); });
$('#ref-upload').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){ app.refImageDataUrl = ev.target.result; refImage.src = app.refImageDataUrl; localStorage.setItem('refImage', app.refImageDataUrl); showMsg('Reference image updated'); };
  reader.readAsDataURL(f);
});
function dataUriPlaceholder(){
  // simple inline SVG placeholder â€” looks sharp on dark/light
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'><rect width='100%' height='100%' fill='#edf2ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#6366f1' font-size='28'>Reference Image Placeholder - Upload your 5-step image</text></svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}
(function loadRefImageFromStorage(){ const d = localStorage.getItem('refImage'); if(d){ app.refImageDataUrl = d; } })();

// --- share / invite link generation ---
function generateInviteLink(){
  // If you want a link to the live GitHub Pages / site replace origin/path accordingly.
  // For now we provide a simple shareable URL that points to current location (works if hosted).
  return location.href;
}
$('#copy-link').addEventListener('click', ()=> {
  const url = generateInviteLink();
  navigator.clipboard?.writeText(url).then(()=> showMsg('Link copied'));
});
$('#share-telegram').addEventListener('click', ()=> {
  const url = encodeURIComponent(generateInviteLink());
  window.open(`https://t.me/share/url?url=${url}&text=${encodeURIComponent('Check out this trading calculator')}`, '_blank');
});
$('#share-whatsapp').addEventListener('click', ()=> {
  const url = encodeURIComponent(generateInviteLink());
  window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent('Try this trading calculator:')}%20${url}`, '_blank');
});

// --- theme toggle ---
$('#theme-toggle').addEventListener('click', ()=>{
  const body = document.body;
  if(body.getAttribute('data-theme') === 'dark'){ body.setAttribute('data-theme','light'); $('#toggle-icon').className='fas fa-moon'; }
  else { body.setAttribute('data-theme','dark'); $('#toggle-icon').className='fas fa-sun'; }
});

// --- help modal wiring ---
$('#help-button').addEventListener('click', ()=> { $('#help-modal').classList.remove('hidden'); $('#help-modal').classList.add('active'); });
$('#help-close').addEventListener('click', ()=> { $('#help-modal').classList.remove('active'); setTimeout(()=>$('#help-modal').classList.add('hidden'), 200); });
$('#help-modal').addEventListener('click', (e)=> { if(e.target === $('#help-modal')) { $('#help-modal').classList.remove('active'); setTimeout(()=>$('#help-modal').classList.add('hidden'), 200); }});
$('#ref-modal').addEventListener('click', (e)=> { if(e.target === $('#ref-modal')) { $('#ref-modal').classList.remove('active'); setTimeout(()=>$('#ref-modal').classList.add('hidden'), 200); }});

// --- tabs wiring ---
$$('#tab-navigation .tab-button').forEach(btn => btn.addEventListener('click', (ev)=>{
  $$('#tab-navigation .tab-button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  app.activeSheet = btn.getAttribute('data-sheet');
  renderActiveSheet();
}));

// --- persistent data load and initial render ---
function init(){
  // load calculations
  loadCalculations();
  // load ref image
  const ri = localStorage.getItem('refImage'); if(ri) app.refImageDataUrl = ri;
  // initial sheet render
  renderActiveSheet();
  // load quote
  loadQuote();
}
init();

/* ================= utilities ================== */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }
</script>
</body>
</html>
