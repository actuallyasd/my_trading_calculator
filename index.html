<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Rules Calculator</title>
  <!-- Favicon (inline SVG candlestick) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect width="64" height="64" rx="12" fill="%230d1117"/>
      <rect x="18" y="18" width="10" height="28" rx="2" fill="%233b82f6"/>
      <rect x="36" y="12" width="10" height="40" rx="2" fill="%23a3e635"/>
      <rect x="23" y="10" width="2" height="12" fill="%233b82f6"/>
      <rect x="41" y="52" width="2" height="10" fill="%23a3e635"/>
    </svg>'/>
  <!-- Tailwind & FA -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    :root { --radius: 16px }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    /* Textured background (light/dark) */
    body[data-theme='dark']{
      background:#0d1117;
      color:#f9fafb;
      background-image:
        radial-gradient(rgba(255,255,255,.03) 1px, transparent 1px),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      background-size:8px 8px, 100% 100%;
    }
    body[data-theme='light']{
      background:#f3f4f6;
      color:#111827;
      background-image:
        radial-gradient(rgba(17,24,39,.04) 1px, transparent 1px),
        linear-gradient(180deg, rgba(0,0,0,.02), transparent);
      background-size:10px 10px, 100% 100%;
    }
    /* Container polish */
    .app-card{
      border-radius: var(--radius);
      box-shadow: 0 24px 60px rgba(2,6,23,.35);
    }
    [data-theme='light'] .app-card{
      box-shadow: 0 18px 40px rgba(16,24,40,.08);
    }
    /* Tab button states */
    .tab-button{ transition: all .25s ease; }
    [data-theme='dark'] .tab-button{ background:#1f2937; color:#cbd5e1; }
    [data-theme='light'] .tab-button{ background:#e5e7eb; color:#374151; }
    .tab-button.active{
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(59,130,246,.35);
    }
    [data-theme='dark'] .tab-button.active{ background:#3b82f6; color:white; }
    [data-theme='light'] .tab-button.active{ background:#111827; color:white; box-shadow:0 10px 30px rgba(17,24,39,.25); }
    /* Input & result fields for visibility */
    .input-field input{
      background: white; color:#111827; border:1px solid #d1d5db;
    }
    [data-theme='dark'] .input-field input{
      background:#111827; color:#f9fafb; border:1px solid #374151;
    }
    .result-field>div{
      border-radius:12px; padding:.75rem 1rem;
      border:1px solid;
    }
    [data-theme='dark'] .result-field>div{
      background:#111827; color:#e5e7eb; border-color:#334155;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    [data-theme='light'] .result-field>div{
      background:#f9fafb; color:#111827; border-color:#e5e7eb;
      box-shadow: 0 8px 20px rgba(0,0,0,.05);
    }
    /* Sheet color tags (unchanged) */
    [data-theme='dark'] .bg-umbrella{ background:#1e3a8a22 }
    [data-theme='light'] .bg-umbrella{ background:#dbeafe }
    [data-theme='dark'] .bg-bike{ background:#065f4622 }
    [data-theme='light'] .bg-bike{ background:#dcfce7 }
    [data-theme='dark'] .bg-rikshaw{ background:#5b21b622 }
    [data-theme='light'] .bg-rikshaw{ background:#ede9fe }
    [data-theme='dark'] .bg-car{ background:#991b1b22 }
    [data-theme='light'] .bg-car{ background:#fee2e2 }
    [data-theme='dark'] .bg-pandavas{ background:#9a341222 }
    [data-theme='light'] .bg-pandavas{ background:#ffedd5 }

    /* Slide transition host */
    .slide-host{ position:relative; overflow:hidden; min-height:420px }
    .slide-panel{
      position:absolute; inset:0;
      opacity:0; transform: translateX(10%);
      transition: transform .35s cubic-bezier(.22,.61,.36,1), opacity .35s ease;
      will-change: transform, opacity;
    }
    .slide-panel.enter{ opacity:1; transform: translateX(0) }
    .slide-from-right{ transform: translateX(12%) }
    .slide-from-left{ transform: translateX(-12%) }
    .slide-to-left{ transform: translateX(-12%); opacity:.001 }
    .slide-to-right{ transform: translateX(12%); opacity:.001 }

    /* Message toast */
    .message-box{
      position: fixed; top: 1rem; right: 1rem; z-index: 50;
      padding:.75rem 1rem; border-radius:.75rem; color:#fff;
      transform: translateY(-10px); opacity:0;
      transition: all .25s ease;
    }
    .message-box.show{ transform:translateY(0); opacity:1 }
  </style>
</head>
<body class="min-h-screen p-4 sm:p-8 transition-colors duration-300" data-theme="dark">
  <div class="max-w-5xl mx-auto">
    <div class="app-card bg-white/5 backdrop-blur-md p-6 sm:p-8 rounded-2xl border border-white/10" id="appCard">
      <!-- Top bar -->
      <div class="flex items-center justify-between gap-3 mb-6">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-white/90 dark:text-white text-center w-full">Trading Rules Calculator</h1>
        <div class="flex-shrink-0 flex items-center gap-2">
          <button id="help-button" class="p-2 rounded-full hover:bg-white/10 text-white/70">
            <i class="fas fa-question text-lg"></i>
          </button>
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 text-white/70">
            <i class="fas fa-sun text-lg" id="toggle-icon"></i>
          </button>
        </div>
      </div>

      <p class="text-center text-white/70 dark:text-gray-400 mb-6 max-w-prose mx-auto text-sm sm:text-base">
        Enter your values and the calculator will compute results based on the selected rule.
      </p>

      <!-- Tabs -->
      <div id="tab-navigation" class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-6">
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold active" data-sheet="Umbrella">Umbrella</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="Bike">Bike</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="Rikshaw">Rikshaw</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="Car">Car</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="Pandavas">Pandavas</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="History">History</button>
        <button class="tab-button py-2 px-4 sm:px-5 rounded-full font-semibold" data-sheet="Notes">Notes</button>
      </div>

      <!-- Slide host -->
      <div id="slide-host" class="slide-host">
        <div id="sheet-content" class="slide-panel enter"></div>
      </div>

      <!-- Share row -->
      <div class="mt-8 pt-6 border-t border-white/10">
        <h3 class="text-center text-lg font-bold text-white/90 mb-4">Share this Calculator</h3>
        <div class="flex flex-wrap justify-center gap-3">
          <button id="share-whatsapp" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </button>
          <button id="share-telegram" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
            <i class="fab fa-telegram-plane"></i> Telegram
          </button>
          <button id="copy-link" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
            <i class="fas fa-copy"></i> Copy Link
          </button>
        </div>
      </div>
    </div>

    <!-- Telegram footer card -->
    <div class="mt-4">
      <div class="bg-gray-900 text-white p-5 rounded-xl shadow-xl flex justify-center items-center">
        <a href="https://t.me/Mathstrade" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-white font-semibold hover:text-indigo-400 transition-colors duration-200">
          <i class="fab fa-telegram-plane text-2xl"></i>
          <span class="text-lg">Connect on Telegram</span>
        </a>
      </div>
    </div>

    <!-- Daily quote (single line, refreshes daily by API; falls back offline) -->
    <div id="daily-quote" class="text-center text-white/80 mt-6 text-sm italic">“Loading today’s trader quote…”</div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="relative w-[92%] max-w-md rounded-2xl p-6 bg-[#111827] text-white shadow-2xl border border-white/10">
      <button id="close-modal" class="absolute top-4 right-4 text-white/70 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-xl font-bold mb-3">How It Works</h2>
      <ul class="space-y-2 text-white/80 text-sm">
        <li><strong>Tabs:</strong> Each tab is a different trading rule. History keeps your saved rows.</li>
        <li><strong>Inputs:</strong> Type values; results update instantly.</li>
        <li><strong>Save:</strong> Click <em>Save Calculation</em> to add it to History.</li>
        <li><strong>CSV:</strong> Export or copy from the History tab.</li>
      </ul>
    </div>
  </div>

  <!-- Toast -->
  <div id="message-box" class="message-box bg-green-600">Saved.</div>

  <script>
    // --- State ---
    const app = {
      theme: 'dark',
      activeSheet: 'Umbrella',
      calculations: [],
      notes: '',
    };

    // --- Utils ---
    const $ = (q, d=document)=>d.querySelector(q);
    const $$ = (q, d=document)=>Array.from(d.querySelectorAll(q));

    const showMessage = (msg, type='success')=>{
      const el = $('#message-box');
      el.textContent = msg;
      el.classList.remove('bg-green-600','bg-red-600');
      el.classList.add(type==='success'?'bg-green-600':'bg-red-600','show');
      setTimeout(()=>el.classList.remove('show'), 2500);
    };

    const copyToClipboard = (text)=>{
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); showMessage('Link copied!'); }
      catch{ showMessage('Copy failed', 'error'); }
      finally{ document.body.removeChild(ta); }
    };

    const debounce=(fn,delay)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay)} };

    // --- Local storage ---
    const saveLS=()=>{
      localStorage.setItem('calc_history', JSON.stringify(app.calculations));
      localStorage.setItem('calc_notes', app.notes || '');
    };
    const loadLS=()=>{
      try{
        app.calculations = JSON.parse(localStorage.getItem('calc_history')||'[]');
        app.notes = localStorage.getItem('calc_notes')||'';
      }catch{ app.calculations=[]; app.notes=''; }
    };

    // --- Sheets (same formulas/IDs you had) ---
    const renderInput = (label,id,val='')=>`
      <div class="input-field">
        <label class="block text-sm font-medium mb-1 text-white/70">${label}</label>
        <input type="number" id="${id}" step="0.01"
               class="w-full rounded-lg py-2 px-3 focus:ring-2 focus:ring-blue-500 focus:outline-none"
               value="${val}" placeholder="Enter value"/>
      </div>`;
    const renderResult=(label,id,val='-')=>`
      <div class="result-field">
        <div>
          <div class="text-[11px] uppercase tracking-wide text-white/60 mb-1">${label}</div>
          <div id="${id}" class="text-xl font-bold">${val}</div>
        </div>
      </div>`;

    const sheets = {
      Umbrella:{
        title:'Umbrella (Daily Candle)',
        cls:'umbrella',
        fields:[
          {t:'in', l:'Previous Day High', id:'umbrella-high'},
          {t:'in', l:'Previous Day Low', id:'umbrella-low'},
          {t:'out',l:'Range (High - Low)', id:'umbrella-range'},
          {t:'out',l:'"X" (Range * 26.11%)', id:'umbrella-x'},
          {t:'out',l:'High - "X"', id:'umbrella-high-minus-x'},
          {t:'out',l:'Low + "X"', id:'umbrella-low-plus-x'},
        ],
        calc(){
          const H=parseFloat($('#umbrella-high').value);
          const L=parseFloat($('#umbrella-low').value);
          if(isNaN(H)||isNaN(L)){ ['umbrella-range','umbrella-x','umbrella-high-minus-x','umbrella-low-plus-x'].forEach(id=>$('#'+id).textContent='-'); return null; }
          const range=H-L, x=range*0.2611, hmx=H-x, lpx=L+x;
          $('#umbrella-range').textContent=range.toFixed(2);
          $('#umbrella-x').textContent=x.toFixed(2);
          $('#umbrella-high-minus-x').textContent=hmx.toFixed(2);
          $('#umbrella-low-plus-x').textContent=lpx.toFixed(2);
          return {name:this.title,date:new Date().toISOString(),inputs:{H,L},results:{range,x,hmx,lpx}};
        }
      },
      Bike:{
        title:'Bike (1/2 Day Candle, 195 Minutes)',
        cls:'bike',
        fields:[
          {t:'in', l:'High', id:'bike-high'},
          {t:'in', l:'Low', id:'bike-low'},
          {t:'out',l:'SQRT(High) "X"', id:'bike-sqrt-high-x'},
          {t:'out',l:'Ding Ding (from "X")', id:'bike-ding-ding-x'},
          {t:'out',l:'High + Ding Ding', id:'bike-high-plus-ding'},
          {t:'out',l:'SQRT(Low) "Y"', id:'bike-sqrt-low-y'},
          {t:'out',l:'Ding Ding (from "Y")', id:'bike-ding-ding-y'},
          {t:'out',l:'Low - Ding Ding', id:'bike-low-minus-ding'},
        ],
        calc(){
          const H=parseFloat($('#bike-high').value);
          const L=parseFloat($('#bike-low').value);
          if(isNaN(H)||isNaN(L)||H<0||L<0){ ['bike-sqrt-high-x','bike-ding-ding-x','bike-high-plus-ding','bike-sqrt-low-y','bike-ding-ding-y','bike-low-minus-ding'].forEach(id=>$('#'+id).textContent='-'); return null; }
          const x=Math.sqrt(H), dx=x*0.2611, hp=H+dx, y=Math.sqrt(L), dy=y*0.2611, lm=L-dy;
          $('#bike-sqrt-high-x').textContent=x.toFixed(2);
          $('#bike-ding-ding-x').textContent=dx.toFixed(2);
          $('#bike-high-plus-ding').textContent=hp.toFixed(2);
          $('#bike-sqrt-low-y').textContent=y.toFixed(2);
          $('#bike-ding-ding-y').textContent=dy.toFixed(2);
          $('#bike-low-minus-ding').textContent=lm.toFixed(2);
          return {name:this.title,date:new Date().toISOString(),inputs:{H,L},results:{x,dx,hp,y,dy,lm}};
        }
      },
      Rikshaw:{
        title:'Rikshaw (5 Minutes Candle)',
        cls:'rikshaw',
        fields:[
          {t:'in', l:'1st 5 Min Candles High', id:'rikshaw-high'},
          {t:'in', l:'1st 5 Min Candles Low', id:'rikshaw-low'},
          {t:'out',l:'High + 0.2611%', id:'rikshaw-high-plus-26'},
          {t:'out',l:'High + 0.1306%', id:'rikshaw-high-plus-13'},
          {t:'out',l:'Low - 0.2611%', id:'rikshaw-low-minus-26'},
          {t:'out',l:'Low - 0.1306%', id:'rikshaw-low-minus-13'},
        ],
        calc(){
          const H=parseFloat($('#rikshaw-high').value);
          const L=parseFloat($('#rikshaw-low').value);
          if(isNaN(H)||isNaN(L)){ ['rikshaw-high-plus-26','rikshaw-high-plus-13','rikshaw-low-minus-26','rikshaw-low-minus-13'].forEach(id=>$('#'+id).textContent='-'); return null; }
          const hp26=H*(1+0.002611), hp13=H*(1+0.001306), lm26=L*(1-0.002611), lm13=L*(1-0.001306);
          $('#rikshaw-high-plus-26').textContent=hp26.toFixed(2);
          $('#rikshaw-high-plus-13').textContent=hp13.toFixed(2);
          $('#rikshaw-low-minus-26').textContent=lm26.toFixed(2);
          $('#rikshaw-low-minus-13').textContent=lm13.toFixed(2);
          return {name:this.title,date:new Date().toISOString(),inputs:{H,L},results:{hp26,hp13,lm26,lm13}};
        }
      },
      Car:{
        title:'Car (5 Minutes Candle, 1 Hour Time Frame)',
        cls:'car',
        fields:[
          {t:'in', l:'1130-1230 High', id:'car-high'},
          {t:'in', l:'1130-1230 Low', id:'car-low'},
          {t:'out',l:'Midpoint (High + Low) / 2', id:'car-midpoint'},
          {t:'out',l:'1.5% Above Midpoint', id:'car-above'},
          {t:'out',l:'1.5% Below Midpoint', id:'car-below'},
        ],
        calc(){
          const H=parseFloat($('#car-high').value);
          const L=parseFloat($('#car-low').value);
          if(isNaN(H)||isNaN(L)){ ['car-midpoint','car-above','car-below'].forEach(id=>$('#'+id).textContent='-'); return null; }
          const mid=(H+L)/2, up=mid*1.015, dn=mid*0.985;
          $('#car-midpoint').textContent=mid.toFixed(2);
          $('#car-above').textContent=up.toFixed(2);
          $('#car-below').textContent=dn.toFixed(2);
          return {name:this.title,date:new Date().toISOString(),inputs:{H,L},results:{mid,up,dn}};
        }
      },
      Pandavas:{
        title:'Pandavas (1/2 Day Candle, 195 Minutes)',
        cls:'pandavas',
        fields:[
          {t:'in', l:"Yesterday's 1st Half High", id:'pandavas-first-high'},
          {t:'in', l:"Yesterday's 1st Half Low", id:'pandavas-first-low'},
          {t:'in', l:"Yesterday's 1st Half Close", id:'pandavas-first-close'},
          {t:'in', l:"Yesterday's 2nd Half High", id:'pandavas-second-high'},
          {t:'in', l:"Yesterday's 2nd Half Low", id:'pandavas-second-low'},
          {t:'in', l:"Yesterday's 2nd Half Close", id:'pandavas-second-close'},
          {t:'out',l:'Average 1 (Pivot)', id:'pandavas-avg1'},
          {t:'out',l:'Average 2 (Pivot)', id:'pandavas-avg2'},
        ],
        calc(){
          const v1=[ 'first-high','first-low','first-close' ].map(s=>parseFloat($('#pandavas-'+s).value));
          const v2=[ 'second-high','second-low','second-close' ].map(s=>parseFloat($('#pandavas-'+s).value));
          const ok1=v1.every(v=>!isNaN(v)), ok2=v2.every(v=>!isNaN(v));
          const avg1= ok1 ? (v1[0]+v1[1]+v1[2])/3 : NaN;
          const avg2= ok2 ? (v2[0]+v2[1]+v2[2])/3 : NaN;
          $('#pandavas-avg1').textContent = isNaN(avg1)?'-':avg1.toFixed(2);
          $('#pandavas-avg2').textContent = isNaN(avg2)?'-':avg2.toFixed(2);
          if(ok1 && ok2){
            return {name:this.title,date:new Date().toISOString(),inputs:{v1:v1, v2:v2},results:{avg1,avg2}};
          }
          return null;
        }
      },
      History:{ title:'Saved History', cls:'umbrella', fields:[] },
      Notes:{ title:'Notes', cls:'umbrella', fields:[] },
    };

    const sheetHTML = (name)=>{
      const s = sheets[name];
      if(['History','Notes'].includes(name)){
        if(name==='History'){
          return `
          <div class="tab-content bg-${s.cls} p-4 sm:p-6 rounded-xl h-full">
            <div class="flex flex-wrap justify-center gap-3 mb-4">
              <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-full">
                <i class="fas fa-file-csv mr-2"></i>Export CSV
              </button>
              <button id="copy-history" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full">
                <i class="fas fa-copy mr-2"></i>Copy All
              </button>
            </div>
            <div class="overflow-auto rounded-lg border border-white/10">
              <table class="min-w-full text-sm">
                <thead class="bg-white/5">
                  <tr>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Rule</th>
                    <th class="px-3 py-2 text-left">Results</th>
                    <th class="px-3 py-2 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
              </table>
            </div>
            <div id="empty-history" class="text-center text-white/60 italic py-4 hidden">No saved calculations yet.</div>
          </div>`;
        }
        // Notes
        return `
        <div class="tab-content bg-${s.cls} p-4 sm:p-6 rounded-xl h-full">
          <textarea id="notes-textarea" class="w-full h-72 rounded-lg border border-white/10 bg-black/30 text-white p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Write notes..."></textarea>
        </div>`;
      }
      // Calculators
      const inputs = s.fields.filter(f=>f.t==='in').map(f=>renderInput(f.l,f.id)).join('');
      const outputs = s.fields.filter(f=>f.t==='out').map(f=>renderResult(f.l,f.id)).join('');
      return `
      <div class="tab-content bg-${s.cls} p-4 sm:p-6 rounded-xl h-full">
        <h2 class="text-xl font-bold mb-4">${s.title}</h2>
        <div class="grid md:grid-cols-2 gap-5">
          <div class="space-y-4">${inputs}</div>
          <div class="grid gap-3">${outputs}</div>
        </div>
        <div class="flex justify-center mt-6">
          <button id="save-calculation" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full">
            <i class="fas fa-save mr-2"></i>Save Calculation
          </button>
        </div>
      </div>`;
    };

    // --- Slide transition renderer ---
    const tabOrder = ['Umbrella','Bike','Rikshaw','Car','Pandavas','History','Notes'];
    const renderWithSlide = (next)=>{
      const host = $('#slide-host');
      const current = $('#sheet-content');
      const nextPanel = document.createElement('div');
      nextPanel.className = 'slide-panel';
      nextPanel.innerHTML = sheetHTML(next);

      const fromIdx = tabOrder.indexOf(app.activeSheet);
      const toIdx = tabOrder.indexOf(next);
      const dirRight = toIdx > fromIdx;

      // position new panel
      nextPanel.classList.add(dirRight ? 'slide-from-right' : 'slide-from-left');
      host.appendChild(nextPanel);

      // trigger reflow then animate
      requestAnimationFrame(()=>{
        nextPanel.classList.add('enter');
        // animate out current
        current.classList.add(dirRight ? 'slide-to-left' : 'slide-to-right');
        // when done, swap ids
        setTimeout(()=>{
          current.remove();
          nextPanel.id = 'sheet-content';
          setupSheet(next); // attach listeners after in-DOM
        }, 370);
      });
    };

    // --- History & CSV ---
    const renderHistoryTable = ()=>{
      const body = $('#history-table-body');
      const empty = $('#empty-history');
      body.innerHTML='';
      if(!app.calculations.length){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      app.calculations.forEach((c,idx)=>{
        const tr = document.createElement('tr');
        tr.className='border-b border-white/10 hover:bg-white/5';
        const resultsHtml = Object.entries(c.results)
          .map(([k,v])=>`<span class="whitespace-nowrap"><b>${k}</b>: ${(typeof v==='number')?v.toFixed(2):v}</span>`)
          .join('<br>');
        tr.innerHTML = `
          <td class="px-3 py-2">${new Date(c.date).toLocaleString()}</td>
          <td class="px-3 py-2">${c.name}</td>
          <td class="px-3 py-2">${resultsHtml}</td>
          <td class="px-3 py-2 text-center">
            <button class="delete-history text-red-400 hover:text-red-200" data-i="${idx}">
              <i class="fas fa-trash"></i>
            </button>
          </td>`;
        body.appendChild(tr);
      });
      body.addEventListener('click', e=>{
        const btn = e.target.closest('.delete-history');
        if(!btn) return;
        const i = +btn.dataset.i;
        if(confirm('Delete this row?')){
          app.calculations.splice(i,1);
          saveLS(); renderHistoryTable(); showMessage('Deleted.');
        }
      }, { once:true });
    };

    const exportCSV = ()=>{
      if(!app.calculations.length){ showMessage('No data to export','error'); return; }
      // Compose wide CSV safely
      const colsInputs = Object.keys(app.calculations[0].inputs||{});
      const colsResults = Object.keys(app.calculations[0].results||{});
      const header = ['Timestamp','Rule',...colsInputs.map(c=>'in_'+c),...colsResults.map(c=>'out_'+c)];
      const rows = app.calculations.map(c=>{
        const ins = colsInputs.map(k=>c.inputs?.[k] ?? '');
        const outs = colsResults.map(k=>{
          const v = c.results?.[k];
          return (typeof v==='number') ? v.toFixed(4) : (v ?? '');
        });
        return [new Date(c.date).toLocaleString(), c.name, ...ins, ...outs];
      });
      const csv = [header, ...rows].map(r=>r.map(cell=>{
        const s = String(cell);
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='trading_rules_history.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showMessage('CSV exported');
    };

    const copyAll = ()=>{
      if(!app.calculations.length){ showMessage('No data to copy','error'); return; }
      const lines = app.calculations.map(c=>{
        const resPairs = Object.entries(c.results).map(([k,v])=>`${k}:${(typeof v==='number')?v.toFixed(4):v}`).join(' | ');
        return `${new Date(c.date).toLocaleString()} — ${c.name} — ${resPairs}`;
      }).join('\n');
      copyToClipboard(lines);
    };

    // --- Sheet wiring ---
    const setupSheet = (name)=>{
      const s = sheets[name];
      // Light up active tab
      $$('#tab-navigation .tab-button').forEach(b=>{
        b.classList.toggle('active', b.dataset.sheet===name);
      });

      if(name==='History'){
        renderHistoryTable();
        $('#export-csv').addEventListener('click', exportCSV);
        $('#copy-history').addEventListener('click', copyAll);
        return;
      }
      if(name==='Notes'){
        const ta = $('#notes-textarea'); ta.value = app.notes || '';
        ta.addEventListener('input', debounce(e=>{ app.notes=e.target.value; saveLS(); }, 300));
        return;
      }
      // calculators: hook inputs -> calc
      const calcFn = s.calc.bind(s);
      s.fields.filter(f=>f.t==='in').forEach(f=>{
        const el = $('#'+f.id);
        el?.addEventListener('input', debounce(calcFn, 150));
      });
      // save button
      $('#save-calculation')?.addEventListener('click', ()=>{
        const c = calcFn();
        if(c){ c.id=Date.now(); app.calculations.unshift(c); saveLS(); showMessage('Saved to history'); }
        else showMessage('Fill inputs first', 'error');
      });
    };

    // --- Tabs with slide ---
    const initTabs = ()=>{
      const buttons = $$('#tab-navigation .tab-button');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const next = btn.dataset.sheet;
          if(next===app.activeSheet) return;
          renderWithSlide(next);
          app.activeSheet = next;
        });
      });
    };

    // --- Share buttons ---
    const initShare = ()=>{
      const shareUrl = window.location.href;
      $('#copy-link').addEventListener('click', ()=>copyToClipboard(shareUrl));
      $('#share-whatsapp').addEventListener('click', ()=>{
        window.open(`https://wa.me/?text=${encodeURIComponent(shareUrl)}`,'_blank');
      });
      $('#share-telegram').addEventListener('click', ()=>{
        window.open(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent('Check this Trading Rules Calculator')}`,'_blank');
      });
    };

    // --- Theme & Help ---
    const initTheme = ()=>{
      const icon = $('#toggle-icon');
      $('#theme-toggle').addEventListener('click', ()=>{
        const dark = document.body.getAttribute('data-theme')==='dark';
        document.body.setAttribute('data-theme', dark?'light':'dark');
        icon.classList.toggle('fa-sun', !dark);
        icon.classList.toggle('fa-moon', dark);
      });
    };
    const initHelp = ()=>{
      const modal = $('#help-modal');
      $('#help-button').addEventListener('click', ()=>{ modal.classList.remove('hidden'); modal.classList.add('flex'); });
      $('#close-modal').addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); });
      modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); } });
    };

    // --- Quote (simple daily) ---
    const initQuote = async ()=>{
      const el = $('#daily-quote');
      try{
        const r = await fetch('https://api.quotable.io/random');
        if(!r.ok) throw new Error('fail');
        const d = await r.json();
        el.textContent = `“${d.content}” — ${d.author}`;
      }catch{
        el.textContent = '“Plan the trade, trade the plan.” — Unknown';
      }
    };

    // --- Boot ---
    window.addEventListener('DOMContentLoaded', ()=>{
      loadLS();
      // first render
      $('#sheet-content').innerHTML = sheetHTML(app.activeSheet);
      setupSheet(app.activeSheet);
      initTabs(); initShare(); initTheme(); initHelp(); initQuote();

      // Make sure active tab is visually highlighted on load
      $$('#tab-navigation .tab-button').forEach(b=>{
        b.classList.toggle('active', b.dataset.sheet===app.activeSheet);
      });
    });
  </script>
</body>
</html>
