<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Rules Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ---------- YOUR ORIGINAL THEME/COMPONENT STYLES (unchanged behavior) ---------- */
        .tab-button { transition: all 0.3s ease-in-out; }
        [data-theme='dark'] .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='light'] .tab-button.active {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='dark'] .tab-button { background-color: #374151; color: #d1d5db; }
        [data-theme='light'] .tab-button { background-color: #e5e7eb; color: #4b5563; }
        [data-theme='dark'] .bg-body { background-color: #0d1117; }
        [data-theme='light'] .bg-body { background-color: #f3f4f6; }
        [data-theme='dark'] .bg-container { background-color: #161b22; }
        [data-theme='light'] .bg-container { background-color: #ffffff; }
        [data-theme='dark'] .text-main { color: #f9fafb; }
        [data-theme='light'] .text-main { color: #1f2937; }
        [data-theme='dark'] .text-secondary { color: #d1d5db; }
        [data-theme='light'] .text-secondary { color: #4b5563; }
        /* Readability fix for inputs and results */
        [data-theme='dark'] .input-field input { background-color: #374151; color: white; border-color: #4b5563; }
        [data-theme='light'] .input-field input { background-color: #ffffff; color: #1f2937; border-color: #d1d5db; }
        [data-theme='dark'] .result-field > div { background-color: #4b5563; color: white; border-color: #6b7280; }
        [data-theme='light'] .result-field > div { background-color: #e5e7eb; color: #1f2937; border-color: #d1d5db; }
        .tab-content > div { border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }

        /* Theme-specific sheet colors (unchanged) */
        [data-theme='dark'] .bg-umbrella { background-color: #1e3a8a; } /* dark blue */
        [data-theme='light'] .bg-umbrella { background-color: #dbeafe; } /* light blue */
        [data-theme='dark'] .text-umbrella { color: #93c5fd; }
        [data-theme='light'] .text-umbrella { color: #1e3a8a; }

        [data-theme='dark'] .bg-bike { background-color: #065f46; } /* dark green */
        [data-theme='light'] .bg-bike { background-color: #dcfce7; } /* light green */
        [data-theme='dark'] .text-bike { color: #6ee7b7; }
        [data-theme='light'] .text-bike { color: #065f46; }

        [data-theme='dark'] .bg-rikshaw { background-color: #5b21b6; } /* dark purple */
        [data-theme='light'] .bg-rikshaw { background-color: #ede9fe; } /* light purple */
        [data-theme='dark'] .text-rikshaw { color: #c4b5fd; }
        [data-theme='light'] .text-rikshaw { color: #5b21b6; }

        [data-theme='dark'] .bg-car { background-color: #991b1b; } /* dark red */
        [data-theme='light'] .bg-car { background-color: #fee2e2; } /* light red */
        [data-theme='dark'] .text-car { color: #fca5a5; }
        [data-theme='light'] .text-car { color: #991b1b; }

        [data-theme='dark'] .bg-pandavas { background-color: #9a3412; } /* dark orange */
        [data-theme='light'] .bg-pandavas { background-color: #ffedd5; } /* light orange */
        [data-theme='dark'] .text-pandavas { color: #fdba74; }
        [data-theme='light'] .text-pandavas { color: #9a3412; }

        [data-theme='dark'] .bg-notes { background-color: #1e40af; } /* dark blue for notes */
        [data-theme='light'] .bg-notes { background-color: #c7d2fe; } /* light blue for notes */
        [data-theme='dark'] .text-notes { color: #93c5fd; }
        [data-theme='light'] .text-notes { color: #1e40af; }

        /* Modal styling (unchanged) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        [data-theme='dark'] .modal-content { background-color: #1f2937; color: #f9fafb; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        [data-theme='light'] .modal-content { background-color: #ffffff; color: #1f2937; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .history-item { cursor: pointer; transition: background-color 0.2s; }
        [data-theme='dark'] .history-item:hover { background-color: #2d3748; }
        [data-theme='light'] .history-item:hover { background-color: #e5e7eb; }

        .message-box {
            position: fixed; top: 1rem; right: 1rem; padding: 1rem 1.5rem; border-radius: 0.5rem;
            background-color: #38a169; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        .message-box.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .history-scroll-container { max-height: 500px; overflow-y: auto; }
        .history-table-container { max-height: 450px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .loading-spinner {
          border: 4px solid rgba(255, 255, 255, 0.1);
          border-left-color: #3b82f6;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          animation: spin 1s linear infinite;
          display: inline-block;
          vertical-align: middle;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* ---------- NEW: textured background + layout polish (non-functional) ---------- */

        /* subtle paper/noise texture using CSS gradients (works offline) */
        body[data-theme='dark'] {
            background-color: #0d1117;
            color: #f9fafb;
            background-image:
                radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.0));
            background-size: 8px 8px, 100% 100%;
        }

        body[data-theme='light'] {
            background-color: #f3f4f6;
            color: #1f2937;
            background-image:
                radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
            background-size: 10px 10px, 100% 100%;
        }

        /* central container visual polish (keeps original sizes & styles) */
        .app-frame {
            width: 100%;
            max-width: 1100px;
            margin: 1.5rem auto;
            padding: 1.25rem;
        }
        .bg-container {
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(2,6,23,0.4);
            transition: box-shadow 0.25s ease;
        }
        [data-theme='light'] .bg-container {
            box-shadow: 0 8px 22px rgba(16,24,40,0.06);
        }

        /* Quote area at the bottom */
        #daily-quote {
            max-width: 1100px;
            margin: 1rem auto 3rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
            opacity: 0.95;
        }
        [data-theme='dark'] #daily-quote {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            color: #e6eefc;
            border: 1px solid rgba(255,255,255,0.03);
        }
        [data-theme='light'] #daily-quote {
            background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
            color: #0f172a;
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* theme toggle quick style */
        #theme-toggle { border-radius: 9999px; padding: 0.5rem; }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This is a global object to hold our Firebase instances
        window.firebase = {
            app: null,
            auth: null,
            db: null
        };
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase on window load
        window.onload = async () => {
            if (Object.keys(window.firebaseConfig).length) {
                window.firebase.app = initializeApp(window.firebaseConfig);
                window.firebase.db = getFirestore(window.firebase.app);
                window.firebase.auth = getAuth(window.firebase.app);

                // Sign in the user using the custom token or anonymously
                try {
                    if (window.initialAuthToken) {
                        await signInWithCustomToken(window.firebase.auth, window.initialAuthToken);
                    } else {
                        await signInAnonymously(window.firebase.auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                }

                // Listen for auth state changes and set up Firestore listeners
                onAuthStateChanged(window.firebase.auth, (user) => {
                    if (user) {
                        console.log("User signed in:", user.uid);
                        window.app.state.userId = user.uid;
                        window.app.setupFirestoreListeners();
                        // Re-render the current tab to use the authenticated user data
                        window.app.renderSheet(window.app.state.activeSheet);
                    } else {
                        console.log("User is signed out.");
                        window.app.state.userId = crypto.randomUUID(); // Fallback for unauthenticated users
                        window.app.setupFirestoreListeners();
                        // Re-render to use the anonymous user data
                        window.app.renderSheet(window.app.state.activeSheet);
                    }
                });
            } else {
                console.warn("Firebase config is missing. Firestore will not be used.");
                window.app.setupFirestoreListeners(); // Still need to call this to run local storage logic
                window.app.state.userId = crypto.randomUUID();
            }
        };
    </script>
</head>

<body class="bg-body min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans transition-colors duration-300" data-theme="dark">

    <div class="app-frame">
        <div class="w-full bg-container transition-colors duration-300 rounded-xl shadow-2xl p-6 sm:p-10">
            <!-- Theme Toggle and Help Button -->
            <div class="flex justify-end gap-2 mb-4">
                <button id="help-button" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-question text-xl"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-sun text-xl" id="toggle-icon"></i>
                </button>
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-main">Trading Rules Calculator</h1>
            <p class="text-center text-secondary mb-8 max-w-prose mx-auto text-sm sm:text-base">
                Enter your values and the calculator will automatically compute the results based on the chosen rule.
            </p>

            <!-- Tab Navigation -->
            <div id="tab-navigation" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600 active" data-sheet="Umbrella">Umbrella</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Bike">Bike</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Rikshaw">Rikshaw</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Car">Car</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Pandavas">Pandavas</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="History">History</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Notes">Notes</button>
            </div>

            <!-- Container for Sheet Content -->
            <div id="sheet-content"></div>

            <!-- Global Sharing Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-center text-xl font-bold text-main mb-4">Share this Calculator</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="share-whatsapp" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button id="share-telegram" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-telegram-plane"></i> Telegram
                    </button>
                    <button id="copy-link" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Link Section (from your original code) -->
    <div class="w-full max-w-4xl mt-4">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-xl flex justify-center items-center">
            <a href="https://t.me/Mathstrade" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-white font-semibold hover:text-indigo-400 transition-colors duration-200">
                <i class="fab fa-telegram-plane text-2xl"></i>
                <span class="text-lg">Connect on Telegram</span>
            </a>
        </div>
    </div>

    <!-- Daily Quote - new element (non functional change) -->
    <div id="daily-quote" aria-live="polite" class="bg-container">
      <div class="flex items-center justify-center space-x-2">
        <div class="loading-spinner"></div>
        <span>Loading today's trader quoteâ€¦</span>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content relative text-center">
            <button id="close-modal" class="absolute top-4 right-4 text-xl text-secondary hover:text-main">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4">How It Works</h2>
            <p class="text-lg text-secondary mb-4">
                This is a trading rules calculator. It helps you quickly determine key trading points based on specific formulas.
            </p>
            <ul class="text-left space-y-2 text-secondary text-sm sm:text-base">
                <li><strong class="text-main">Tabs:</strong> Each tab represents a different trading rule with its own unique calculation. The History tab shows all your saved data.</li>
                <li><strong class="text-main">Input Fields:</strong> Enter the required values (High, Low, etc.) for the selected rule.</li>
                <li><strong class="text-main">Results:</strong> The calculated results will appear automatically as you type or press 'Enter'.</li>
                <li><strong class="text-main">History:</strong> Save calculations for later and manage your saved data in the new History tab.</li>
                <li><strong class="text-main">CSV Options:</strong> In the History tab, you can export all your saved calculations as a single CSV file or copy them to your clipboard.</li>
            </ul>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Global App State
        window.app = {
            state: {
                theme: 'dark',
                activeSheet: 'Umbrella',
                calculations: [],
                notes: "",
                userId: null,
                isAuthReady: false,
                appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
            },
            firebase: {
                db: null,
                auth: null
            },
        };

        // Debounce function to limit how often a function is called
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Utility function to show a temporary message box
        const showMessage = (message, type = 'success') => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `message-box show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        };

        // Dynamic HTML for input and result fields
        const renderInputField = (label, id) => `
            <div class="input-field mb-4">
                <label for="${id}" class="block text-sm font-medium text-secondary">${label}</label>
                <input type="number" id="${id}" step="0.01" class="mt-1 block w-full rounded-md shadow-sm border border-gray-300 py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter value" />
            </div>
        `;
        const renderResultField = (label, id) => `
            <div class="result-field bg-gray-200 dark:bg-gray-700 p-3 rounded-md shadow-inner">
                <div class="text-xs font-semibold uppercase text-secondary">${label}</div>
                <div id="${id}" class="text-xl font-bold mt-1 text-main">-</div>
            </div>
        `;

        // Sheet Definitions with new render functions
        const sheets = {
            Umbrella: {
                title: "Umbrella (Daily Candle)",
                class: "umbrella",
                fields: [
                    { type: 'input', label: 'Previous Day High', id: 'umbrella-high' },
                    { type: 'input', label: 'Previous Day Low', id: 'umbrella-low' },
                    { type: 'result', label: 'Range (High - Low)', id: 'umbrella-range' },
                    { type: 'result', label: '"X" (Range * 26.11%)', id: 'umbrella-x' },
                    { type: 'result', label: 'High - "X"', id: 'umbrella-high-minus-x' },
                    { type: 'result', label: 'Low + "X"', id: 'umbrella-low-plus-x' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('umbrella-high').value);
                    const low = parseFloat(document.getElementById('umbrella-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const range = high - low;
                        const x = range * 0.2611;
                        const highMinusX = high - x;
                        const lowPlusX = low + x;

                        document.getElementById('umbrella-range').textContent = range.toFixed(2);
                        document.getElementById('umbrella-x').textContent = x.toFixed(2);
                        document.getElementById('umbrella-high-minus-x').textContent = highMinusX.toFixed(2);
                        document.getElementById('umbrella-low-plus-x').textContent = lowPlusX.toFixed(2);
                        return { inputs: { high, low }, results: { range, x, highMinusX, lowPlusX } };
                    } else {
                        document.getElementById('umbrella-range').textContent = '-';
                        document.getElementById('umbrella-x').textContent = '-';
                        document.getElementById('umbrella-high-minus-x').textContent = '-';
                        document.getElementById('umbrella-low-plus-x').textContent = '-';
                        return null;
                    }
                }
            },
            Bike: {
                title: "Bike (1/2 Day Candle, 195 Minutes)",
                class: "bike",
                fields: [
                    { type: 'input', label: 'High', id: 'bike-high' },
                    { type: 'input', label: 'Low', id: 'bike-low' },
                    { type: 'result', label: 'SQRT(High) "X"', id: 'bike-sqrt-high-x' },
                    { type: 'result', label: 'Ding Ding (from "X")', id: 'bike-ding-ding-x' },
                    { type: 'result', label: 'High + Ding Ding', id: 'bike-high-plus-ding' },
                    { type: 'result', label: 'SQRT(Low) "Y"', id: 'bike-sqrt-low-y' },
                    { type: 'result', label: 'Ding Ding (from "Y")', id: 'bike-ding-ding-y' },
                    { type: 'result', label: 'Low - Ding Ding', id: 'bike-low-minus-ding' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('bike-high').value);
                    const low = parseFloat(document.getElementById('bike-low').value);

                    if (!isNaN(high) && !isNaN(low) && high >= 0 && low >= 0) {
                        const sqrtHighX = Math.sqrt(high);
                        const dingDingX = sqrtHighX * 0.2611;
                        const highPlusDingDing = high + dingDingX;
                        const sqrtLowY = Math.sqrt(low);
                        const dingDingY = sqrtLowY * 0.2611;
                        const lowMinusDingDing = low - dingDingY;

                        document.getElementById('bike-sqrt-high-x').textContent = sqrtHighX.toFixed(2);
                        document.getElementById('bike-ding-ding-x').textContent = dingDingX.toFixed(2);
                        document.getElementById('bike-high-plus-ding').textContent = highPlusDingDing.toFixed(2);
                        document.getElementById('bike-sqrt-low-y').textContent = sqrtLowY.toFixed(2);
                        document.getElementById('bike-ding-ding-y').textContent = dingDingY.toFixed(2);
                        document.getElementById('bike-low-minus-ding').textContent = lowMinusDingDing.toFixed(2);
                        return {
                            inputs: { high, low },
                            results: { sqrtHighX, dingDingX, highPlusDingDing, sqrtLowY, dingDingY, lowMinusDingDing }
                        };
                    } else {
                        document.getElementById('bike-sqrt-high-x').textContent = '-';
                        document.getElementById('bike-ding-ding-x').textContent = '-';
                        document.getElementById('bike-high-plus-ding').textContent = '-';
                        document.getElementById('bike-sqrt-low-y').textContent = '-';
                        document.getElementById('bike-ding-ding-y').textContent = '-';
                        document.getElementById('bike-low-minus-ding').textContent = '-';
                        return null;
                    }
                }
            },
            Rikshaw: {
                title: "Rikshaw (5 Minutes Candle)",
                class: "rikshaw",
                fields: [
                    { type: 'input', label: '1st 5 Min Candles High', id: 'rikshaw-high' },
                    { type: 'input', label: '1st 5 Min Candles Low', id: 'rikshaw-low' },
                    { type: 'result', label: 'High + 0.2611%', id: 'rikshaw-high-plus-26' },
                    { type: 'result', label: 'High + 0.1306%', id: 'rikshaw-high-plus-13' },
                    { type: 'result', label: 'Low - 0.2611%', id: 'rikshaw-low-minus-26' },
                    { type: 'result', label: 'Low - 0.1306%', id: 'rikshaw-low-minus-13' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('rikshaw-high').value);
                    const low = parseFloat(document.getElementById('rikshaw-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const highPlus26 = high * (1 + 0.002611);
                        const highPlus13 = high * (1 + 0.001306);
                        const lowMinus26 = low * (1 - 0.002611);
                        const lowMinus13 = low * (1 - 0.001306);

                        document.getElementById('rikshaw-high-plus-26').textContent = highPlus26.toFixed(2);
                        document.getElementById('rikshaw-high-plus-13').textContent = highPlus13.toFixed(2);
                        document.getElementById('rikshaw-low-minus-26').textContent = lowMinus26.toFixed(2);
                        document.getElementById('rikshaw-low-minus-13').textContent = lowMinus13.toFixed(2);
                        return { inputs: { high, low }, results: { highPlus26, highPlus13, lowMinus26, lowMinus13 } };
                    } else {
                        document.getElementById('rikshaw-high-plus-26').textContent = '-';
                        document.getElementById('rikshaw-high-plus-13').textContent = '-';
                        document.getElementById('rikshaw-low-minus-26').textContent = '-';
                        document.getElementById('rikshaw-low-minus-13').textContent = '-';
                        return null;
                    }
                }
            },
            Car: {
                title: "Car (5 Minutes Candle, 1 Hour Time Frame)",
                class: "car",
                fields: [
                    { type: 'input', label: '1130-1230 High', id: 'car-high' },
                    { type: 'input', label: '1130-1230 Low', id: 'car-low' },
                    { type: 'result', label: 'Midpoint (High + Low) / 2', id: 'car-midpoint' },
                    { type: 'result', label: '1.5% Above Midpoint', id: 'car-above' },
                    { type: 'result', label: '1.5% Below Midpoint', id: 'car-below' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('car-high').value);
                    const low = parseFloat(document.getElementById('car-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const midpoint = (high + low) / 2;
                        const aboveMidpoint = midpoint * 1.015;
                        const belowMidpoint = midpoint * 0.985;

                        document.getElementById('car-midpoint').textContent = midpoint.toFixed(2);
                        document.getElementById('car-above').textContent = aboveMidpoint.toFixed(2);
                        document.getElementById('car-below').textContent = belowMidpoint.toFixed(2);
                        return { inputs: { high, low }, results: { midpoint, aboveMidpoint, belowMidpoint } };
                    } else {
                        document.getElementById('car-midpoint').textContent = '-';
                        document.getElementById('car-above').textContent = '-';
                        document.getElementById('car-below').textContent = '-';
                        return null;
                    }
                }
            },
            Pandavas: {
                title: "Pandavas (1/2 Day Candle, 195 Minutes)",
                class: "pandavas",
                fields: [
                    { type: 'input', label: "Yesterday's 1st Half High", id: 'pandavas-first-high' },
                    { type: 'input', label: "Yesterday's 1st Half Low", id: 'pandavas-first-low' },
                    { type: 'input', label: "Yesterday's 1st Half Close", id: 'pandavas-first-close' },
                    { type: 'input', label: "Yesterday's 2nd Half High", id: 'pandavas-second-high' },
                    { type: 'input', label: "Yesterday's 2nd Half Low", id: 'pandavas-second-low' },
                    { type: 'input', label: "Yesterday's 2nd Half Close", id: 'pandavas-second-close' },
                    { type: 'result', label: "Average 1 (Pivot)", id: 'pandavas-avg1' },
                    { type: 'result', label: "Average 2 (Pivot)", id: 'pandavas-avg2' },
                ],
                calculate: () => {
                    const values1 = [
                        parseFloat(document.getElementById('pandavas-first-high').value),
                        parseFloat(document.getElementById('pandavas-first-low').value),
                        parseFloat(document.getElementById('pandavas-first-close').value)
                    ];
                    const values2 = [
                        parseFloat(document.getElementById('pandavas-second-high').value),
                        parseFloat(document.getElementById('pandavas-second-low').value),
                        parseFloat(document.getElementById('pandavas-second-close').value)
                    ];

                    let avg1 = NaN;
                    let avg2 = NaN;
                    let validValues1 = values1.filter(val => !isNaN(val));
                    let validValues2 = values2.filter(val => !isNaN(val));

                    if (validValues1.length === 3) {
                        const sum = validValues1.reduce((acc, current) => acc + current, 0);
                        avg1 = sum / 3;
                    }
                    if (validValues2.length === 3) {
                        const sum = validValues2.reduce((acc, current) => acc + current, 0);
                        avg2 = sum / 3;
                    }

                    document.getElementById('pandavas-avg1').textContent = !isNaN(avg1) ? avg1.toFixed(2) : '-';
                    document.getElementById('pandavas-avg2').textContent = !isNaN(avg2) ? avg2.toFixed(2) : '-';
                    return { inputs: { values1, values2 }, results: { avg1, avg2 } };
                }
            },
            History: {
                title: "Calculation History",
                class: "history",
                fields: [], // No static fields
                calculate: () => null // No calculation needed here
            },
            Notes: {
                title: "My Trading Notes",
                class: "notes",
                fields: [], // No static fields
                calculate: () => null // No calculation needed here
            }
        };

        // Renders the UI for a given sheet
        window.app.renderSheet = (sheetName) => {
            const sheet = sheets[sheetName];
            const contentDiv = document.getElementById('sheet-content');

            // Render different content based on the sheet type
            let innerContent = "";
            if (sheetName === 'History') {
                innerContent = `
                    <div class="bg-container p-6 sm:p-8 rounded-lg min-h-[400px]">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-main mb-4 sm:mb-0">Calculation History</h2>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button id="history-export-csv-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-file-csv"></i> Export as CSV
                                </button>
                                <button id="history-copy-clipboard-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-copy"></i> Copy to Clipboard
                                </button>
                                <button id="history-clear-all-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                    <i class="fas fa-trash-alt"></i> Clear All
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 history-table-container bg-container rounded-lg p-2">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-container sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Rule</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Values</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Results</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-secondary uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="history-list" class="divide-y divide-gray-700 text-sm">
                                    ${window.app.state.calculations.length > 0 ?
                                        window.app.state.calculations.map(calc => `
                                            <tr class="history-item hover:bg-gray-800 transition-colors" data-id="${calc.id}">
                                                <td class="px-3 py-2 whitespace-nowrap text-secondary">${new Date(calc.timestamp.seconds * 1000).toLocaleString()}</td>
                                                <td class="px-3 py-2 whitespace-nowrap font-medium text-main">${calc.sheet}</td>
                                                <td class="px-3 py-2 whitespace-pre-wrap text-secondary">${Object.entries(calc.inputs).map(([key, val]) => `${key}: ${val}`).join(', ')}</td>
                                                <td class="px-3 py-2 whitespace-pre-wrap text-secondary">${Object.entries(calc.results).map(([key, val]) => `${key}: ${val ? val.toFixed(2) : '-'}`).join(', ')}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                                                    <button class="history-delete-button text-red-500 hover:text-red-700" data-id="${calc.id}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')
                                    : `<tr class="text-center"><td colspan="5" class="py-4 text-secondary">No saved calculations yet.</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-center text-sm text-secondary">
                          Your userId: <span class="font-mono text-xs text-blue-400">${window.app.state.userId || 'Loading...'}</span>
                        </div>
                    </div>
                `;
            } else if (sheetName === 'Notes') {
                innerContent = `
                    <div class="bg-notes p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-notes">My Trading Notes</h2>
                        <textarea id="notes-textarea" class="w-full h-80 p-4 rounded-md shadow-sm border border-gray-300 bg-white text-gray-800 resize-y focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                `;
            } else {
                let fieldsHtml = sheet.fields.map(field => {
                    if (field.type === 'input') return renderInputField(field.label, field.id);
                    if (field.type === 'result') return renderResultField(field.label, field.id);
                }).join('');

                innerContent = `
                    <div class="bg-${sheet.class} p-6 sm:p-8 rounded-lg">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-${sheet.class}">${sheet.title}</h2>
                        ${sheetName === 'Car' ? `<p class="text-secondary mb-4">This rule calculates the midpoint and a percentage range for your trading points.</p>` : ''}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${fieldsHtml}
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-6">
                            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = innerContent;
            
            // Re-attach event listeners for the newly rendered content
            if (sheetName === 'Notes') {
                const notesTextarea = document.getElementById('notes-textarea');
                notesTextarea.value = window.app.state.notes;
                notesTextarea.addEventListener('input', debounce(() => {
                    if (window.app.firebase.db && window.app.state.userId) {
                        saveNotesToFirestore(notesTextarea.value);
                    }
                }, 500));
            } else if (sheetName === 'History') {
                document.getElementById('history-export-csv-button').addEventListener('click', exportToCSV);
                document.getElementById('history-copy-clipboard-button').addEventListener('click', copyToClipboard);
                document.getElementById('history-clear-all-button').addEventListener('click', clearAllHistory);
                document.querySelectorAll('.history-delete-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const docId = e.currentTarget.dataset.id;
                        deleteCalculationFromFirestore(docId);
                    });
                });
            } else {
                const saveButton = document.getElementById('save-button');
                if (saveButton) {
                    saveButton.addEventListener('click', () => {
                        const calculationData = sheet.calculate();
                        if (calculationData) {
                            saveCalculationToFirestore(sheetName, calculationData.inputs, calculationData.results);
                        } else {
                            showMessage("Please enter valid numbers to save.", "error");
                        }
                    });
                }
                const inputFields = contentDiv.querySelectorAll('input');
                inputFields.forEach(input => {
                    input.addEventListener('input', debounce(sheet.calculate, 300));
                });
                sheet.calculate(); // Initial calculation
            }
        };

        // Firestore CRUD operations
        const saveCalculationToFirestore = async (sheet, inputs, results) => {
            const { db, auth } = window.app.firebase;
            const { userId, appId } = window.app.state;
            if (!db || !userId) {
                console.error("Firestore not initialized or user ID missing.");
                showMessage("Database connection error. Please try again.", "error");
                return;
            }
            try {
                const docRef = await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/calculations`), {
                    sheet: sheet,
                    inputs: inputs,
                    results: results,
                    timestamp: serverTimestamp()
                });
                showMessage("Calculation saved successfully!");
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error saving calculation.", "error");
            }
        };

        const deleteCalculationFromFirestore = async (docId) => {
            const { db, auth } = window.app.firebase;
            const { userId, appId } = window.app.state;
            if (!db || !userId) {
                console.error("Firestore not initialized or user ID missing.");
                showMessage("Database connection error.", "error");
                return;
            }
            try {
                await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/calculations`, docId));
                showMessage("Calculation deleted successfully!");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Error deleting calculation.", "error");
            }
        };
        
        const clearAllHistory = async () => {
            const { db, auth } = window.app.firebase;
            const { userId, appId } = window.app.state;
            if (!db || !userId) {
                console.error("Firestore not initialized or user ID missing.");
                showMessage("Database connection error.", "error");
                return;
            }
            
            try {
              const calculationsRef = collection(db, `/artifacts/${appId}/users/${userId}/calculations`);
              const querySnapshot = await getDocs(calculationsRef);
              const batch = writeBatch(db);
              querySnapshot.forEach(doc => {
                  batch.delete(doc.ref);
              });
              await batch.commit();
              showMessage("All history cleared successfully!");
            } catch (e) {
                console.error("Error clearing all history: ", e);
                showMessage("Error clearing history.", "error");
            }
        };

        const saveNotesToFirestore = async (notesContent) => {
            const { db, auth } = window.app.firebase;
            const { userId, appId } = window.app.state;
            if (!db || !userId) {
                console.error("Firestore not initialized or user ID missing.");
                showMessage("Database connection error.", "error");
                return;
            }
            try {
                const notesRef = doc(db, `/artifacts/${appId}/users/${userId}/notes/user_notes`);
                await setDoc(notesRef, { content: notesContent, timestamp: serverTimestamp() });
                showMessage("Notes saved successfully!");
            } catch (e) {
                console.error("Error saving notes: ", e);
                showMessage("Error saving notes.", "error");
            }
        };

        // Firestore Real-time Listeners
        window.app.setupFirestoreListeners = () => {
            const { db } = window.app.firebase;
            const { userId, appId } = window.app.state;

            if (!db || !userId) {
                console.log("Firestore or userId not available. Skipping listeners.");
                return;
            }

            // Listen for changes in calculations
            const calculationsRef = collection(db, `/artifacts/${appId}/users/${userId}/calculations`);
            onSnapshot(calculationsRef, (snapshot) => {
                const calculations = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    calculations.push({ id: doc.id, ...data });
                });
                calculations.sort((a, b) => b.timestamp - a.timestamp);
                window.app.state.calculations = calculations;
                if (window.app.state.activeSheet === 'History') {
                    window.app.renderSheet('History');
                }
            });

            // Listen for changes in notes
            const notesRef = doc(db, `/artifacts/${appId}/users/${userId}/notes/user_notes`);
            onSnapshot(notesRef, (doc) => {
                if (doc.exists()) {
                    window.app.state.notes = doc.data().content;
                } else {
                    window.app.state.notes = "";
                }
                if (window.app.state.activeSheet === 'Notes') {
                    window.app.renderSheet('Notes');
                }
            });
        };

        // History tab utility functions
        const exportToCSV = () => {
            const calculations = window.app.state.calculations;
            if (calculations.length === 0) {
                showMessage("No data to export.", "error");
                return;
            }

            let csv = "Timestamp,Rule,Input Values,Results\n";
            calculations.forEach(calc => {
                const date = new Date(calc.timestamp.seconds * 1000).toLocaleString();
                const inputs = Object.entries(calc.inputs).map(([k, v]) => `${k}=${v}`).join('; ');
                const results = Object.entries(calc.results).map(([k, v]) => `${k}=${v ? v.toFixed(2) : '-'}`).join('; ');
                csv += `"${date}","${calc.sheet}","${inputs}","${results}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "trading_calculations.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("CSV file downloaded!");
            }
        };

        const copyToClipboard = () => {
            const calculations = window.app.state.calculations;
            if (calculations.length === 0) {
                showMessage("No data to copy.", "error");
                return;
            }

            const header = "Date\tRule\tInput Values\tResults\n";
            const data = calculations.map(calc => {
                const date = new Date(calc.timestamp.seconds * 1000).toLocaleString();
                const inputs = Object.entries(calc.inputs).map(([k, v]) => `${k}=${v}`).join('; ');
                const results = Object.entries(calc.results).map(([k, v]) => `${k}=${v ? v.toFixed(2) : '-'}`).join('; ');
                return `${date}\t${calc.sheet}\t${inputs}\t${results}`;
            }).join('\n');
            const textToCopy = header + data;

            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            showMessage("History copied to clipboard!");
        };

        // Daily Quote logic using Gemini API
        const fetchDailyQuote = async () => {
            const quoteEl = document.getElementById('daily-quote');
            if (!quoteEl) return;

            quoteEl.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading today's trader quoteâ€¦</span></div>`;
            const prompt = `Provide a short, inspiring quote about trading or finance from a well-known investor, trader, or economist. The quote should be no more than two sentences. The response should be a plain text string in the format "Quote" - Author.`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                let result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    quoteEl.textContent = text;
                } else {
                    quoteEl.textContent = "Error: Failed to get quote. Please try again later.";
                    console.error("Gemini API response structure is unexpected or content is missing.");
                }
            } catch (error) {
                console.error("Error fetching daily quote:", error);
                quoteEl.textContent = "Error: Failed to get quote.";
            }
        };


        // Main App Logic
        document.addEventListener('DOMContentLoaded', () => {
            // Initial render
            const params = new URLSearchParams(window.location.search);
            const initialSheet = params.get('sheet') || 'Umbrella';
            window.app.state.activeSheet = initialSheet;
            window.app.renderSheet(initialSheet);
            
            // Set initial theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.dataset.theme = savedTheme;
            window.app.state.theme = savedTheme;
            document.getElementById('toggle-icon').className = savedTheme === 'dark' ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';

            // Attach event listeners
            document.getElementById('tab-navigation').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-button')) {
                    const sheetName = e.target.dataset.sheet;
                    window.app.state.activeSheet = sheetName;
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    // Update URL without reloading
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('sheet', sheetName);
                    window.history.pushState({}, '', newUrl);

                    window.app.renderSheet(sheetName);
                }
            });

            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                document.body.dataset.theme = newTheme;
                window.app.state.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                document.getElementById('toggle-icon').className = newTheme === 'dark' ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
            });
            
            document.getElementById('help-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('active');
            });

            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('help-modal').classList.remove('active');
            });

            document.getElementById('share-whatsapp').addEventListener('click', () => {
                const shareText = `Check out this Trading Rules Calculator: ${window.location.href}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
            });

            document.getElementById('share-telegram').addEventListener('click', () => {
                const shareText = `Check out this Trading Rules Calculator: ${window.location.href}`;
                window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`, '_blank');
            });

            document.getElementById('copy-link').addEventListener('click', () => {
                const tempInput = document.createElement("input");
                tempInput.value = window.location.href;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessage("Link copied to clipboard!");
            });

            // Fetch the daily quote
            fetchDailyQuote();
        });
    </script>
</body>
</html>
