<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Rules Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ---------- YOUR ORIGINAL THEME/COMPONENT STYLES (unchanged behavior) ---------- */
        .tab-button { transition: all 0.3s ease-in-out; }
        [data-theme='dark'] .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='light'] .tab-button.active {
            background-color: #1f2937;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        [data-theme='dark'] .tab-button { background-color: #374151; color: #d1d5db; }
        [data-theme='light'] .tab-button { background-color: #e5e7eb; color: #4b5563; }
        [data-theme='dark'] .bg-body { background-color: #0d1117; }
        [data-theme='light'] .bg-body { background-color: #f3f4f6; }
        [data-theme='dark'] .bg-container { background-color: #161b22; }
        [data-theme='light'] .bg-container { background-color: #ffffff; }
        [data-theme='dark'] .text-main { color: #f9fafb; }
        [data-theme='light'] .text-main { color: #1f2937; }
        [data-theme='dark'] .text-secondary { color: #d1d5db; }
        [data-theme='light'] .text-secondary { color: #4b5563; }
        /* Readability fix for inputs and results */
        [data-theme='dark'] .input-field input { background-color: #374151; color: white; border-color: #4b5563; }
        [data-theme='light'] .input-field input { background-color: #ffffff; color: #1f2937; border-color: #d1d5db; }
        /* ----- UPDATED OUTPUT BOX STYLES FOR iOS-INSPIRED LOOK ----- */
        [data-theme='dark'] .result-field > div { 
            background-color: #374151; /* Deeper gray for dark theme */
            color: #f9fafb; 
            border: 1px solid #4b5563; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); /* Subtle dark shadow */
            transition: all 0.2s ease;
        }
        [data-theme='light'] .result-field > div { 
            background-color: #f9fafb; /* Lighter background for light theme */
            color: #1f2937; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); /* Subtle light shadow */
            transition: all 0.2s ease;
        }
        /* Common styles for result fields */
        .result-field > div { 
            border-radius: 0.75rem; /* More rounded corners */
        }
        /* ----------------------------------------------------------- */
        
        .tab-content > div { border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }

        /* Theme-specific sheet colors (unchanged) */
        [data-theme='dark'] .bg-umbrella { background-color: #1e3a8a; } /* dark blue */
        [data-theme='light'] .bg-umbrella { background-color: #dbeafe; } /* light blue */
        [data-theme='dark'] .text-umbrella { color: #93c5fd; }
        [data-theme='light'] .text-umbrella { color: #1e3a8a; }

        [data-theme='dark'] .bg-bike { background-color: #065f46; } /* dark green */
        [data-theme='light'] .bg-bike { background-color: #dcfce7; } /* light green */
        [data-theme='dark'] .text-bike { color: #6ee7b7; }
        [data-theme='light'] .text-bike { color: #065f46; }

        [data-theme='dark'] .bg-rikshaw { background-color: #5b21b6; } /* dark purple */
        [data-theme='light'] .bg-rikshaw { background-color: #ede9fe; } /* light purple */
        [data-theme='dark'] .text-rikshaw { color: #c4b5fd; }
        [data-theme='light'] .text-rikshaw { color: #5b21b6; }

        [data-theme='dark'] .bg-car { background-color: #991b1b; } /* dark red */
        [data-theme='light'] .bg-car { background-color: #fee2e2; } /* light red */
        [data-theme='dark'] .text-car { color: #fca5a5; }
        [data-theme='light'] .text-car { color: #991b1b; }

        [data-theme='dark'] .bg-pandavas { background-color: #9a3412; } /* dark orange */
        [data-theme='light'] .bg-pandavas { background-color: #ffedd5; } /* light orange */
        [data-theme='dark'] .text-pandavas { color: #fdba74; }
        [data-theme='light'] .text-pandavas { color: #9a3412; }

        [data-theme='dark'] .bg-notes { background-color: #1e40af; } /* dark blue for notes */
        [data-theme='light'] .bg-notes { background-color: #c7d2fe; } /* light blue for notes */
        [data-theme='dark'] .text-notes { color: #93c5fd; }
        [data-theme='light'] .text-notes { color: #1e40af; }

        /* Modal styling (unchanged) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        [data-theme='dark'] .modal-content { background-color: #1f2937; color: #f9fafb; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        [data-theme='light'] .modal-content { background-color: #ffffff; color: #1f2937; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .history-item { cursor: pointer; transition: background-color 0.2s; }
        [data-theme='dark'] .history-item:hover { background-color: #2d3748; }
        [data-theme='light'] .history-item:hover { background-color: #e5e7eb; }

        .message-box {
            position: fixed; top: 1rem; right: 1rem; padding: 1rem 1.5rem; border-radius: 0.5rem;
            background-color: #38a169; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        .message-box.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .history-scroll-container { max-height: 500px; overflow-y: auto; }
        .history-table-container { max-height: 450px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .loading-spinner {
          border: 4px solid rgba(255, 255, 255, 0.1);
          border-left-color: #3b82f6;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          animation: spin 1s linear infinite;
          display: inline-block;
          vertical-align: middle;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* ---------- NEW: textured background + layout polish (non-functional) ---------- */

        /* subtle paper/noise texture using CSS gradients (works offline) */
        body[data-theme='dark'] {
            background-color: #0d1117;
            color: #f9fafb;
            background-image:
                radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.0));
            background-size: 8px 8px, 100% 100%;
        }

        body[data-theme='light'] {
            background-color: #f3f4f6;
            color: #1f2937;
            background-image:
                radial-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.0));
            background-size: 10px 10px, 100% 100%;
        }

        /* central container visual polish (keeps original sizes & styles) */
        .app-frame {
            width: 100%;
            max-width: 1100px;
            margin: 1.5rem auto;
            padding: 1.25rem;
        }
        .bg-container {
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(2,6,23,0.4);
            transition: box-shadow 0.25s ease;
        }
        [data-theme='light'] .bg-container {
            box-shadow: 0 8px 22px rgba(16,24,40,0.06);
        }

        /* Quote area at the bottom */
        #daily-quote {
            max-width: 1100px;
            margin: 1rem auto 3rem;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
            opacity: 0.95;
        }
        [data-theme='dark'] #daily-quote {
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            color: #e6eefc;
            border: 1px solid rgba(255,255,255,0.03);
        }
        [data-theme='light'] #daily-quote {
            background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
            color: #0f172a;
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* theme toggle quick style */
        #theme-toggle { border-radius: 9999px; padding: 0.5rem; }
    </style>
</head>

<body class="bg-body min-h-screen p-4 sm:p-8 flex flex-col items-center font-sans transition-colors duration-300" data-theme="dark">

    <div class="app-frame">
        <div class="w-full bg-container transition-colors duration-300 rounded-xl shadow-2xl p-6 sm:p-10">
            <!-- Theme Toggle and Help Button -->
            <div class="flex justify-end gap-2 mb-4">
                <button id="help-button" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-question text-xl"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:bg-gray-700 transition-colors duration-200">
                    <i class="fas fa-sun text-xl" id="toggle-icon"></i>
                </button>
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-main">Trading Rules Calculator</h1>
            <p class="text-center text-secondary mb-8 max-w-prose mx-auto text-sm sm:text-base">
                Enter your values and the calculator will automatically compute the results based on the chosen rule.
            </p>

            <!-- Tab Navigation -->
            <div id="tab-navigation" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600 active" data-sheet="Umbrella">Umbrella</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Bike">Bike</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Rikshaw">Rikshaw</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Car">Car</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Pandavas">Pandavas</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="History">History</button>
                <button class="tab-button py-2 px-4 sm:px-6 rounded-full font-semibold hover:bg-gray-600" data-sheet="Notes">Notes</button>
            </div>

            <!-- Container for Sheet Content -->
            <div id="sheet-content"></div>

            <!-- Global Sharing Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-center text-xl font-bold text-main mb-4">Share this Calculator</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="share-whatsapp" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button id="share-telegram" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fab fa-telegram-plane"></i> Telegram
                    </button>
                    <button id="copy-link" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Link Section (from your original code) -->
    <div class="w-full max-w-4xl mt-4">
        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-xl flex justify-center items-center">
            <a href="https://t.me/Mathstrade" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-white font-semibold hover:text-indigo-400 transition-colors duration-200">
                <i class="fab fa-telegram-plane text-2xl"></i>
                <span class="text-lg">Connect on Telegram</span>
            </a>
        </div>
    </div>

    <!-- Daily Quote - new element (non functional change) -->
    <div id="daily-quote" aria-live="polite" class="bg-container">
      <div class="flex items-center justify-center space-x-2">
        <div class="loading-spinner"></div>
        <span>Loading today's trader quote…</span>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content relative text-center">
            <button id="close-modal" class="absolute top-4 right-4 text-xl text-secondary hover:text-main">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4">How It Works</h2>
            <p class="text-lg text-secondary mb-4">
                This is a trading rules calculator. It helps you quickly determine key trading points based on specific formulas.
            </p>
            <ul class="text-left space-y-2 text-secondary text-sm sm:text-base">
                <li><strong class="text-main">Tabs:</strong> Each tab represents a different trading rule with its own unique calculation. The History tab shows all your saved data.</li>
                <li><strong class="text-main">Input Fields:</strong> Enter the required values (High, Low, etc.) for the selected rule.</li>
                <li><strong class="text-main">Results:</strong> The calculated results will appear automatically as you type or press 'Enter'.</li>
                <li><strong class="text-main">History:</strong> Save calculations for later and manage your saved data in the new History tab.</li>
                <li><strong class="text-main">CSV Options:</strong> In the History tab, you can export all your saved calculations as a single CSV file or copy them to your clipboard.</li>
            </ul>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Global App State
        window.app = {
            state: {
                theme: 'dark',
                activeSheet: 'Umbrella',
                calculations: [],
                notes: "",
                userId: null,
            },
        };

        // Debounce function to limit how often a function is called
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Utility function to show a temporary message box
        const showMessage = (message, type = 'success') => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `message-box show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        };

        // Dynamic HTML for input and result fields
        const renderInputField = (label, id) => `
            <div class="input-field mb-4">
                <label for="${id}" class="block text-sm font-medium text-secondary">${label}</label>
                <input type="number" id="${id}" step="0.01" class="mt-1 block w-full rounded-md shadow-sm border border-gray-300 py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter value" />
            </div>
        `;
        const renderResultField = (label, id) => `
            <div class="result-field p-3">
                <div class="text-xs font-semibold uppercase text-secondary">${label}</div>
                <div id="${id}" class="text-xl font-bold mt-1 text-main">-</div>
            </div>
        `;

        // Local Storage Functions
        const saveToLocalStorage = () => {
            localStorage.setItem('calculations', JSON.stringify(window.app.state.calculations));
            localStorage.setItem('notes', window.app.state.notes);
            // We don't need a success message every time the user types.
        };

        const loadFromLocalStorage = () => {
            const savedCalculations = localStorage.getItem('calculations');
            const savedNotes = localStorage.getItem('notes');
            if (savedCalculations) {
                window.app.state.calculations = JSON.parse(savedCalculations);
            }
            if (savedNotes) {
                window.app.state.notes = savedNotes;
            }
        };

        // Sheet Definitions with new render functions
        const sheets = {
            Umbrella: {
                title: "Umbrella (Daily Candle)",
                class: "umbrella",
                fields: [
                    { type: 'input', label: 'Previous Day High', id: 'umbrella-high' },
                    { type: 'input', label: 'Previous Day Low', id: 'umbrella-low' },
                    { type: 'result', label: 'Range (High - Low)', id: 'umbrella-range' },
                    { type: 'result', label: '"X" (Range * 26.11%)', id: 'umbrella-x' },
                    { type: 'result', label: 'High - "X"', id: 'umbrella-high-minus-x' },
                    { type: 'result', label: 'Low + "X"', id: 'umbrella-low-plus-x' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('umbrella-high').value);
                    const low = parseFloat(document.getElementById('umbrella-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const range = high - low;
                        const x = range * 0.2611;
                        const highMinusX = high - x;
                        const lowPlusX = low + x;

                        document.getElementById('umbrella-range').textContent = range.toFixed(2);
                        document.getElementById('umbrella-x').textContent = x.toFixed(2);
                        document.getElementById('umbrella-high-minus-x').textContent = highMinusX.toFixed(2);
                        document.getElementById('umbrella-low-plus-x').textContent = lowPlusX.toFixed(2);
                        return { inputs: { high, low }, results: { range, x, highMinusX, lowPlusX } };
                    } else {
                        document.getElementById('umbrella-range').textContent = '-';
                        document.getElementById('umbrella-x').textContent = '-';
                        document.getElementById('umbrella-high-minus-x').textContent = '-';
                        document.getElementById('umbrella-low-plus-x').textContent = '-';
                        return null;
                    }
                }
            },
            Bike: {
                title: "Bike (1/2 Day Candle, 195 Minutes)",
                class: "bike",
                fields: [
                    { type: 'input', label: 'High', id: 'bike-high' },
                    { type: 'input', label: 'Low', id: 'bike-low' },
                    { type: 'result', label: 'SQRT(High) "X"', id: 'bike-sqrt-high-x' },
                    { type: 'result', label: 'Ding Ding (from "X")', id: 'bike-ding-ding-x' },
                    { type: 'result', label: 'High + Ding Ding', id: 'bike-high-plus-ding' },
                    { type: 'result', label: 'SQRT(Low) "Y"', id: 'bike-sqrt-low-y' },
                    { type: 'result', label: 'Ding Ding (from "Y")', id: 'bike-ding-ding-y' },
                    { type: 'result', label: 'Low - Ding Ding', id: 'bike-low-minus-ding' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('bike-high').value);
                    const low = parseFloat(document.getElementById('bike-low').value);

                    if (!isNaN(high) && !isNaN(low) && high >= 0 && low >= 0) {
                        const sqrtHighX = Math.sqrt(high);
                        const dingDingX = sqrtHighX * 0.2611;
                        const highPlusDingDing = high + dingDingX;
                        const sqrtLowY = Math.sqrt(low);
                        const dingDingY = sqrtLowY * 0.2611;
                        const lowMinusDingDing = low - dingDingY;

                        document.getElementById('bike-sqrt-high-x').textContent = sqrtHighX.toFixed(2);
                        document.getElementById('bike-ding-ding-x').textContent = dingDingX.toFixed(2);
                        document.getElementById('bike-high-plus-ding').textContent = highPlusDingDing.toFixed(2);
                        document.getElementById('bike-sqrt-low-y').textContent = sqrtLowY.toFixed(2);
                        document.getElementById('bike-ding-ding-y').textContent = dingDingY.toFixed(2);
                        document.getElementById('bike-low-minus-ding').textContent = lowMinusDingDing.toFixed(2);
                        return {
                            inputs: { high, low },
                            results: { sqrtHighX, dingDingX, highPlusDingDing, sqrtLowY, dingDingY, lowMinusDingDing }
                        };
                    } else {
                        document.getElementById('bike-sqrt-high-x').textContent = '-';
                        document.getElementById('bike-ding-ding-x').textContent = '-';
                        document.getElementById('bike-high-plus-ding').textContent = '-';
                        document.getElementById('bike-sqrt-low-y').textContent = '-';
                        document.getElementById('bike-ding-ding-y').textContent = '-';
                        document.getElementById('bike-low-minus-ding').textContent = '-';
                        return null;
                    }
                }
            },
            Rikshaw: {
                title: "Rikshaw (5 Minutes Candle)",
                class: "rikshaw",
                fields: [
                    { type: 'input', label: '1st 5 Min Candles High', id: 'rikshaw-high' },
                    { type: 'input', label: '1st 5 Min Candles Low', id: 'rikshaw-low' },
                    { type: 'result', label: 'High + 0.2611%', id: 'rikshaw-high-plus-26' },
                    { type: 'result', label: 'High + 0.1306%', id: 'rikshaw-high-plus-13' },
                    { type: 'result', label: 'Low - 0.2611%', id: 'rikshaw-low-minus-26' },
                    { type: 'result', label: 'Low - 0.1306%', id: 'rikshaw-low-minus-13' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('rikshaw-high').value);
                    const low = parseFloat(document.getElementById('rikshaw-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const highPlus26 = high * (1 + 0.002611);
                        const highPlus13 = high * (1 + 0.001306);
                        const lowMinus26 = low * (1 - 0.002611);
                        const lowMinus13 = low * (1 - 0.001306);

                        document.getElementById('rikshaw-high-plus-26').textContent = highPlus26.toFixed(2);
                        document.getElementById('rikshaw-high-plus-13').textContent = highPlus13.toFixed(2);
                        document.getElementById('rikshaw-low-minus-26').textContent = lowMinus26.toFixed(2);
                        document.getElementById('rikshaw-low-minus-13').textContent = lowMinus13.toFixed(2);
                        return { inputs: { high, low }, results: { highPlus26, highPlus13, lowMinus26, lowMinus13 } };
                    } else {
                        document.getElementById('rikshaw-high-plus-26').textContent = '-';
                        document.getElementById('rikshaw-high-plus-13').textContent = '-';
                        document.getElementById('rikshaw-low-minus-26').textContent = '-';
                        document.getElementById('rikshaw-low-minus-13').textContent = '-';
                        return null;
                    }
                }
            },
            Car: {
                title: "Car (5 Minutes Candle, 1 Hour Time Frame)",
                class: "car",
                fields: [
                    { type: 'input', label: '1130-1230 High', id: 'car-high' },
                    { type: 'input', label: '1130-1230 Low', id: 'car-low' },
                    { type: 'result', label: 'Midpoint (High + Low) / 2', id: 'car-midpoint' },
                    { type: 'result', label: '1.5% Above Midpoint', id: 'car-above' },
                    { type: 'result', label: '1.5% Below Midpoint', id: 'car-below' },
                ],
                calculate: () => {
                    const high = parseFloat(document.getElementById('car-high').value);
                    const low = parseFloat(document.getElementById('car-low').value);

                    if (!isNaN(high) && !isNaN(low)) {
                        const midpoint = (high + low) / 2;
                        const aboveMidpoint = midpoint * 1.015;
                        const belowMidpoint = midpoint * 0.985;

                        document.getElementById('car-midpoint').textContent = midpoint.toFixed(2);
                        document.getElementById('car-above').textContent = aboveMidpoint.toFixed(2);
                        document.getElementById('car-below').textContent = belowMidpoint.toFixed(2);
                        return { inputs: { high, low }, results: { midpoint, aboveMidpoint, belowMidpoint } };
                    } else {
                        document.getElementById('car-midpoint').textContent = '-';
                        document.getElementById('car-above').textContent = '-';
                        document.getElementById('car-below').textContent = '-';
                        return null;
                    }
                }
            },
            Pandavas: {
                title: "Pandavas (1/2 Day Candle, 195 Minutes)",
                class: "pandavas",
                fields: [
                    { type: 'input', label: "Yesterday's 1st Half High", id: 'pandavas-first-high' },
                    { type: 'input', label: "Yesterday's 1st Half Low", id: 'pandavas-first-low' },
                    { type: 'input', label: "Yesterday's 1st Half Close", id: 'pandavas-first-close' },
                    { type: 'input', label: "Yesterday's 2nd Half High", id: 'pandavas-second-high' },
                    { type: 'input', label: "Yesterday's 2nd Half Low", id: 'pandavas-second-low' },
                    { type: 'input', label: "Yesterday's 2nd Half Close", id: 'pandavas-second-close' },
                    { type: 'result', label: "Average 1 (Pivot)", id: 'pandavas-avg1' },
                    { type: 'result', label: "Average 2 (Pivot)", id: 'pandavas-avg2' },
                ],
                calculate: () => {
                    const values1 = [
                        parseFloat(document.getElementById('pandavas-first-high').value),
                        parseFloat(document.getElementById('pandavas-first-low').value),
                        parseFloat(document.getElementById('pandavas-first-close').value)
                    ];
                    const values2 = [
                        parseFloat(document.getElementById('pandavas-second-high').value),
                        parseFloat(document.getElementById('pandavas-second-low').value),
                        parseFloat(document.getElementById('pandavas-second-close').value)
                    ];

                    let avg1 = NaN;
                    let avg2 = NaN;
                    let validValues1 = values1.filter(val => !isNaN(val));
                    let validValues2 = values2.filter(val => !isNaN(val));

                    if (validValues1.length === 3) {
                        const sum = validValues1.reduce((acc, current) => acc + current, 0);
                        avg1 = sum / 3;
                    }
                    if (validValues2.length === 3) {
                        const sum = validValues2.reduce((acc, current) => acc + current, 0);
                        avg2 = sum / 3;
                    }

                    document.getElementById('pandavas-avg1').textContent = !isNaN(avg1) ? avg1.toFixed(2) : '-';
                    document.getElementById('pandavas-avg2').textContent = !isNaN(avg2) ? avg2.toFixed(2) : '-';
                    
                    if (!isNaN(avg1) && !isNaN(avg2)) {
                        return { inputs: { values1, values2 }, results: { avg1, avg2 } };
                    } else {
                        return null;
                    }
                }
            },
            History: {
                title: "Saved History",
                class: "history",
                fields: [],
                calculate: () => {}, // No calculation for this sheet
            },
            Notes: {
                title: "Notes",
                class: "notes",
                fields: [],
                calculate: () => {}, // No calculation for this sheet
            }
        };

        const generateSheetHTML = (sheetName) => {
            const sheet = sheets[sheetName];
            const isInputSheet = ['Umbrella', 'Bike', 'Rikshaw', 'Car', 'Pandavas'].includes(sheetName);
            let html = `
                <div class="tab-content bg-${sheet.class} bg-opacity-20 p-6 rounded-lg transition-colors duration-300">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-${sheet.class}">${sheet.title}</h2>
            `;

            if (isInputSheet) {
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
                const inputFields = sheet.fields.filter(f => f.type === 'input');
                const resultFields = sheet.fields.filter(f => f.type === 'result');

                // Inputs side
                html += '<div class="flex flex-col gap-4">';
                inputFields.forEach(field => {
                    html += renderInputField(field.label, field.id);
                });
                html += `<button id="save-calculation" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-200 mt-4">
                            <i class="fas fa-save mr-2"></i> Save Calculation
                         </button>`;
                html += '</div>';

                // Results side
                html += '<div class="grid grid-cols-1 gap-4">';
                resultFields.forEach(field => {
                    html += renderResultField(field.label, field.id);
                });
                html += '</div>';
                
                html += '</div>';
            } else if (sheetName === 'History') {
                html += renderHistorySheet();
            } else if (sheetName === 'Notes') {
                html += renderNotesSheet();
            }

            html += `</div>`;
            return html;
        };

        const renderHistorySheet = () => {
            let historyHtml = `
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="clear-history" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i> Clear All History
                        </button>
                        <button id="copy-history" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-copy"></i> Copy as CSV
                        </button>
                        <button id="export-history" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 flex items-center gap-2">
                            <i class="fas fa-file-csv"></i> Export as CSV
                        </button>
                    </div>
                    <div id="history-table-container" class="history-table-container mt-4 bg-container rounded-lg p-4">
            `;
            if (window.app.state.calculations.length === 0) {
                historyHtml += '<p class="text-center text-secondary">No saved calculations yet. Save some from the other tabs!</p>';
            } else {
                historyHtml += `
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead>
                            <tr class="text-secondary text-left">
                                <th class="py-2 px-4 font-semibold text-sm">Date</th>
                                <th class="py-2 px-4 font-semibold text-sm">Rule</th>
                                <th class="py-2 px-4 font-semibold text-sm">Inputs</th>
                                <th class="py-2 px-4 font-semibold text-sm">Results</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-600" id="history-table-body">
                `;
                window.app.state.calculations.forEach(calc => {
                    const inputsStr = Object.entries(calc.inputs).map(([key, val]) => `${key}: ${val}`).join(', ');
                    const resultsStr = Object.entries(calc.results).map(([key, val]) => `${key}: ${val}`).join(', ');
                    historyHtml += `
                        <tr class="text-main history-item hover:bg-gray-800">
                            <td class="py-2 px-4 text-sm whitespace-nowrap">${new Date(calc.date).toLocaleString()}</td>
                            <td class="py-2 px-4 text-sm">${calc.rule}</td>
                            <td class="py-2 px-4 text-sm">${inputsStr}</td>
                            <td class="py-2 px-4 text-sm">${resultsStr}</td>
                        </tr>
                    `;
                });
                historyHtml += `
                        </tbody>
                    </table>
                `;
            }
            historyHtml += `
                    </div>
                </div>
            `;
            return historyHtml;
        };

        const renderNotesSheet = () => {
            const notesHtml = `
                <div class="flex flex-col h-full">
                    <textarea id="notes-content" class="w-full flex-grow p-4 rounded-lg bg-container text-main border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="15" placeholder="Write your trading notes here..."></textarea>
                </div>
            `;
            return notesHtml;
        };
        
        // Main rendering function
        const renderActiveSheet = () => {
            const sheetContent = document.getElementById('sheet-content');
            const activeSheet = window.app.state.activeSheet;
            const sheet = sheets[activeSheet];
            
            // Clear previous content and render new sheet
            sheetContent.innerHTML = generateSheetHTML(activeSheet);

            // Add event listeners based on the active sheet
            const isInputSheet = ['Umbrella', 'Bike', 'Rikshaw', 'Car', 'Pandavas'].includes(activeSheet);
            if (isInputSheet) {
                const inputFields = sheet.fields.filter(f => f.type === 'input');
                const debouncedCalculate = debounce(() => {
                    const result = sheet.calculate();
                }, 300);

                inputFields.forEach(field => {
                    const inputElement = document.getElementById(field.id);
                    if (inputElement) {
                        inputElement.addEventListener('input', debouncedCalculate);
                        // Also trigger calculation on load with pre-filled values if any
                        debouncedCalculate();
                    }
                });
                
                const saveButton = document.getElementById('save-calculation');
                saveButton.addEventListener('click', () => {
                    const result = sheet.calculate();
                    if (result) {
                        const timestamp = new Date().toISOString();
                        window.app.state.calculations.push({
                            date: timestamp,
                            rule: activeSheet,
                            inputs: result.inputs,
                            results: result.results
                        });
                        saveToLocalStorage();
                        showMessage(`Calculation for ${activeSheet} saved!`);
                    } else {
                        showMessage('Please enter valid numbers to save.', 'error');
                    }
                });
            } else if (activeSheet === 'History') {
                const clearButton = document.getElementById('clear-history');
                clearButton.addEventListener('click', () => {
                    window.app.state.calculations = [];
                    saveToLocalStorage();
                    renderActiveSheet();
                    showMessage('History cleared!');
                });

                const copyButton = document.getElementById('copy-history');
                copyButton.addEventListener('click', () => {
                    const csvContent = convertToCSV(window.app.state.calculations);
                    copyToClipboard(csvContent);
                });

                const exportButton = document.getElementById('export-history');
                exportButton.addEventListener('click', () => {
                    const csvContent = convertToCSV(window.app.state.calculations);
                    downloadCSV(csvContent, 'trading-history.csv');
                });
            } else if (activeSheet === 'Notes') {
                const notesTextarea = document.getElementById('notes-content');
                if (notesTextarea) {
                    notesTextarea.value = window.app.state.notes;
                    notesTextarea.addEventListener('input', debounce((e) => {
                        window.app.state.notes = e.target.value;
                        saveToLocalStorage();
                    }, 500));
                }
            }
        };

        const convertToCSV = (data) => {
            if (data.length === 0) return '';
            const headers = ['Date', 'Rule', 'Inputs', 'Results'];
            const csvRows = [headers.join(',')];

            data.forEach(calc => {
                const date = `"${new Date(calc.date).toLocaleString()}"`;
                const rule = `"${calc.rule}"`;
                const inputs = `"${Object.entries(calc.inputs).map(([key, val]) => `${key}: ${val}`).join('; ')}"`;
                const results = `"${Object.entries(calc.results).map(([key, val]) => `${key}: ${val}`).join('; ')}"`;
                csvRows.push([date, rule, inputs, results].join(','));
            });

            return csvRows.join('\n');
        };

        const copyToClipboard = (text) => {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                showMessage('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy to clipboard.', 'error');
            }
            document.body.removeChild(tempTextArea);
        };

        const downloadCSV = (content, filename) => {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('CSV file downloaded!');
            } else {
                showMessage('Your browser does not support downloading files.', 'error');
            }
        };

        // Quote of the day from Gemini API
        const fetchDailyQuote = async () => {
          const quoteElement = document.getElementById('daily-quote');
          const loadingHtml = `<div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading today's trader quote…</span></div>`;
          quoteElement.innerHTML = loadingHtml;
          const prompt = "Generate a short, inspiring, and unique quote about trading or investing, no more than 20 words. Do not use quotes from famous people. Just provide the quote itself, with no attribution or extra text.";

          // Exponential backoff for API calls
          let retryCount = 0;
          const maxRetries = 3;
          let delay = 1000;

          while (retryCount < maxRetries) {
            try {
              const chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = ""
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
              
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
              }
              
              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0 &&
                  result.candidates[0].content && result.candidates[0].content.parts &&
                  result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text.trim();
                quoteElement.innerHTML = `&ldquo;${text}&rdquo;`;
                return;
              } else {
                throw new Error('Unexpected API response format');
              }
            } catch (error) {
              console.error(`Attempt ${retryCount + 1} failed:`, error);
              if (retryCount < maxRetries - 1) {
                await new Promise(res => setTimeout(res, delay));
                delay *= 2; // Exponential backoff
              } else {
                quoteElement.textContent = "Failed to load quote. Please try again later.";
              }
              retryCount++;
            }
          }
        };


        // Main Initialization
        const init = () => {
            loadFromLocalStorage();
            renderActiveSheet();
            fetchDailyQuote();

            // Tab Navigation
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelector('.tab-button.active').classList.remove('active');
                    button.classList.add('active');
                    window.app.state.activeSheet = button.dataset.sheet;
                    renderActiveSheet();
                });
            });

            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');
            const toggleIcon = document.getElementById('toggle-icon');
            const body = document.body;

            const updateThemeIcon = (theme) => {
                if (theme === 'dark') {
                    toggleIcon.classList.remove('fa-sun');
                    toggleIcon.classList.add('fa-moon');
                } else {
                    toggleIcon.classList.remove('fa-moon');
                    toggleIcon.classList.add('fa-sun');
                }
            };

            themeToggle.addEventListener('click', () => {
                const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', newTheme);
                window.app.state.theme = newTheme;
                updateThemeIcon(newTheme);
            });
            // Set initial theme icon
            updateThemeIcon(window.app.state.theme);

            // Help Modal
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const closeModal = document.getElementById('close-modal');
            const modalOverlay = document.getElementById('help-modal');

            helpButton.addEventListener('click', () => {
                helpModal.classList.remove('hidden');
                setTimeout(() => helpModal.classList.add('active'), 10);
            });

            closeModal.addEventListener('click', () => {
                helpModal.classList.remove('active');
                setTimeout(() => helpModal.classList.add('hidden'), 300);
            });

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    helpModal.classList.remove('active');
                    setTimeout(() => helpModal.classList.add('hidden'), 300);
                }
            });

            // Share Buttons
            const shareUrl = window.location.href;
            const shareText = "Check out this awesome Trading Rules Calculator!";

            document.getElementById('share-whatsapp').addEventListener('click', () => {
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText + " " + shareUrl)}`, '_blank');
            });
            document.getElementById('share-telegram').addEventListener('click', () => {
                window.open(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`, '_blank');
            });
            document.getElementById('copy-link').addEventListener('click', () => {
                copyToClipboard(shareUrl);
            });
        };

        window.addEventListener('load', init);

    </script>
</body>
</html>
